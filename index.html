<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>i-Nano Lab</title>
    <link rel="icon" type="image/png" href="Images/inanoresearchfacilityDLSUlogo.png" />
    <style>
        body {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #2c3e50;
            background-color: #f8f9fa;
        }

        * {
            box-sizing: border-box;
        }

        .header {
            position: fixed;
            top: 0;
            width: 100%;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #e9ecef;
            z-index: 1000;
            padding: 1rem 0;
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0 2rem;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2c3e50;
            text-decoration: none;
            display: inline-block;
            line-height: 0; /* remove extra whitespace around inline image */
        }

        .logo img {
            height: 48px;
            width: auto;
            max-width: 90vw;
            display: block;
        }

        .brand {
            display: inline-flex;
            align-items: center;
            gap: 12px;
            color: #2c3e50;
            text-decoration: none;
        }

        .brand-text {
            font-size: 1.1rem;
            font-weight: 600;
            line-height: 1.2;
            color: #2c3e50;
            white-space: nowrap;
        }

        @media (max-width: 600px) {
            .brand-text {
                display: none;
            }
        }

        @media (max-width: 480px) {
            .logo img {
                height: 40px;
            }
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            border-top: 1px solid #e9ecef;
            z-index: 1000;
            padding: 0.5rem 0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }

        .nav-buttons {
            display: flex;
            justify-content: space-around;
            align-items: center;
            max-width: 600px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        .nav-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: #6c757d;
            transition: all 0.3s ease;
            padding: 0.5rem;
            border-radius: 8px;
            min-width: 60px;
        }

        .nav-button:hover,
        .nav-button.active {
            color: #e67e22;
            background: rgba(230, 126, 34, 0.1);
        }

        .nav-button-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #27ae60;
            color: #ffffff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            margin-bottom: 0.25rem;
        }

        .nav-button-text {
            font-size: 0.7rem;
            font-weight: 500;
            text-align: center;
            line-height: 1.2;
        }

        /* Emphasize Service Request icon */
        .nav-button[data-section="request"] .nav-button-icon {
            width: 48px;
            height: 48px;
            font-size: 1.25rem;
        }

        /* Hero section removed */

        .cta-button {
            display: inline-block;
            background: #3498db;
            color: white;
            padding: 1rem 2rem;
            text-decoration: none;
            border-radius: 5px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            font-size: 1rem;
        }

        .cta-button:hover {
            background: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }

        /* Subtle/secondary action button */
        .btn-subtle {
            display: inline-block;
            background: #f1f3f5;
            color: #2c3e50;
            padding: 0.75rem 1.25rem;
            text-decoration: none;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.95rem;
            border: 1px solid #dee2e6;
            transition: background 0.2s ease, border-color 0.2s ease, transform 0.15s ease;
            box-shadow: none;
        }
        .btn-subtle:hover {
            background: #e9ecef;
            border-color: #cfd4da;
            transform: translateY(-1px);
        }
        .btn-subtle:focus {
            outline: 3px solid rgba(52, 152, 219, 0.35);
            outline-offset: 2px;
        }

        /* Main Content */
        .main-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem 6rem;
            margin-top: 100px; /* spacing below fixed header after hero removal */
        }

        .section {
            padding: 4rem 0;
            border-bottom: 1px solid #e9ecef;
        }

        .section:first-child {
            padding-top: 0;
        }

        .section:last-child {
            border-bottom: none;
        }

        .section h2 {
            font-size: 2.5rem;
            margin-bottom: 2rem;
            color: #2c3e50;
            text-align: center;
            font-weight: 300;
        }
        .section-subtitle {
            max-width: 960px;
            margin: -0.5rem auto 1.25rem;
            font-size: 1rem;
            line-height: 1.7;
            color: #6c757d;
            text-align: center;
        }

        /* About Section */
        .about-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 3rem;
            align-items: center;
            margin-top: 2rem;
        }

        .about-text {
            font-size: 1.1rem;
            line-height: 1.8;
        }

        .team-placeholder {
            background: #e9ecef;
            height: 300px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            font-size: 1.1rem;
        }

        /* Team Section */
        .team-heading {
            margin: 0 0 0.75rem 0;
            color: #2c3e50;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .team-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1.25rem;
        }

        .team-card {
            background: #ffffff;
            border-radius: 10px;
            padding: 1.25rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border: 2px solid transparent;
            text-align: center;
            transition: transform 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .team-card:hover {
            transform: translateY(-4px);
            border-color: #3498db;
            box-shadow: 0 8px 20px rgba(0,0,0,0.12);
        }

        .team-photo {
            width: 112px;
            height: 112px;
            border-radius: 50%;
            object-fit: cover;
            display: block;
            margin: 0 auto 0.75rem;
            box-shadow: 0 0 0 4px rgba(52, 152, 219, 0.12);
            background: #f1f3f5;
        }

        .team-name {
            font-weight: 700;
            color: #2c3e50;
            margin-top: 0.25rem;
        }

        .team-role {
            color: #6c757d;
            font-weight: 500;
            margin-top: 0.15rem;
        }

        /* Cost Analysis Section */
        .pricing-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }

        .pricing-card {
            background: white;
            border-radius: 10px;
            padding: 2rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
            border: 2px solid transparent;
        }

        .pricing-card:hover {
            transform: translateY(-5px);
            border-color: #3498db;
        }

        .pricing-card h3 {
            color: #3498db;
            margin-bottom: 1rem;
            font-size: 1.5rem;
        }

        /* About Services visuals */
        .service-header {
            width: 100%;
            height: auto;
            border-radius: 8px;
            display: block;
            margin-bottom: 1rem;
        }

        .price {
            font-size: 2rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 1rem;
        }

        .pricing-features {
            list-style: none;
            padding: 0;
        }

        .pricing-features li {
            padding: 0.5rem 0;
            border-bottom: 1px solid #f8f9fa;
        }

        .pricing-features li:before {
            content: '✓';
            color: #27ae60;
            font-weight: bold;
            margin-right: 0.5rem;
        }

        /* Calculator */
        .calculator {
            background: white;
            border-radius: 10px;
            padding: 2rem;
            margin-top: 2rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .calculator h3 {
            color: #3498db;
            margin-bottom: 1.5rem;
        }

        .calc-help {
            margin: 0.35rem 0 0;
            font-size: 0.9rem;
            color: #6c757d;
            line-height: 1.4;
        }

        .calc-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .calc-input {
            display: flex;
            flex-direction: column;
        }

        .calc-input label {
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #2c3e50;
        }

        .calc-input input, .calc-input select {
            padding: 0.75rem;
            border: 2px solid #e9ecef;
            border-radius: 5px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .calc-input input[type="range"] {
            padding: 0; /* remove number input padding for slider */
            border: none;
            width: 100%;
            margin-top: 0.5rem;
        }

        .calc-input input:focus, .calc-input select:focus {
            outline: none;
            border-color: #3498db;
        }

        .calc-result {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 5px;
            margin-top: 1rem;
            text-align: center;
        }

        .calc-total {
            font-size: 1.5rem;
            font-weight: 700;
            color: #3498db;
        }

        /* Promo banner (Request form) */
        .promo-banner {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.75rem;
            background: #eef2ff;
            border: 1px solid #bfdbfe;
            color: #1e3a8a;
            padding: 0.6rem 0.85rem;
            border-radius: 8px;
            margin: 0.5rem 0 1rem;
            font-size: 0.95rem;
            line-height: 1.4;
            flex-wrap: wrap;
        }
        .promo-banner > span { flex: 1 1 auto; min-width: 220px; }
        .promo-banner .promo-dismiss {
            appearance: none;
            -webkit-appearance: none;
            background: transparent;
            border: none;
            color: #1e3a8a;
            cursor: pointer;
            width: 32px;
            height: 32px;
            line-height: 32px;
            border-radius: 6px;
            font-size: 18px;
            font-weight: 700;
            text-align: center;
            transition: background 0.15s ease, color 0.15s ease;
        }
        .promo-banner .promo-dismiss:hover { background: rgba(191, 219, 254, 0.35); }
        .promo-banner .promo-dismiss:focus { outline: 2px solid #bfdbfe; outline-offset: 2px; }

        /* Voucher + Summary (Request form) */
        .services-voucher {
            margin-top: 0.75rem;
        }
        .services-voucher label {
            font-weight: 600;
            color: #2c3e50;
            display: block;
            margin-bottom: 0.35rem;
        }
        .voucher-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .voucher-row input[type="text"] {
            flex: 1;
            padding: 0.6rem 0.75rem;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 0.95rem;
        }
        .voucher-row input[type="text"]:focus {
            outline: none;
            border-color: #3498db;
        }
        .voucher-row input[type="text"][disabled] {
            background: #f1f3f5;
            color: #6c757d;
            cursor: not-allowed;
        }
        .voucher-actions { 
            margin-top: 0.5rem; 
            display: flex; 
            align-items: center; 
            gap: 0.5rem; 
        }
        .voucher-row .btn-apply, .voucher-actions .btn-apply {
            padding: 0.55rem 0.9rem;
            border: none;
            border-radius: 6px;
            background: #3498db;
            color: #fff;
            font-weight: 600;
            cursor: pointer;
        }
        .voucher-row .btn-apply:hover, .voucher-actions .btn-apply:hover { background: #2980b9; }
        .voucher-row .btn-clear, .voucher-actions .btn-clear {
            padding: 0.45rem 0.6rem;
            border: none;
            background: transparent;
            color: #6c757d;
            text-decoration: underline;
            cursor: pointer;
        }
        #voucher-status {
            font-size: 0.9rem;
            margin-top: 0.35rem;
        }
        #voucher-status.success { color: #155724; }
        #voucher-status.error { color: #721c24; }

        .services-summary {
            margin-top: 0.5rem;
        }
        .services-summary .summary-row {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-top: 0.25rem;
        }
        .services-summary .summary-label {
            color: #6c757d;
        }
        .services-summary .summary-value {
            min-width: 160px;
            text-align: right;
            font-weight: 600;
        }
        .services-summary .summary-total .summary-label { color: #2c3e50; font-weight: 700; }
        .services-summary .summary-total .summary-value { color: #3498db; font-weight: 700; }

        /* Sample Preparation */
        .prep-steps {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }

        .prep-step {
            background: white;
            border-radius: 10px;
            padding: 2rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
            border: 2px solid transparent;
            transition: transform 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .prep-step:hover,
        .prep-step:focus-within {
            transform: translateY(-4px);
            border-color: #3498db;
            box-shadow: 0 8px 20px rgba(0,0,0,0.12);
        }
        .prep-photo {
            display: block;
            width: 100%;
            height: auto;
            border-radius: 8px;
            margin: 0.5rem 0 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }

        /* Sample Prep - Quick Readiness Checklist */
        .checklist-card {
            background: #ffffff;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.06);
            padding: 1.25rem;
            margin-top: 1rem;
            transition: border-color 0.25s ease, box-shadow 0.25s ease;
        }
        .checklist-card.ready {
            border-color: #27ae60;
            box-shadow: 0 8px 20px rgba(39, 174, 96, 0.15);
        }
        .checklist-card h3 {
            margin: 0 0 0.25rem 0;
        }
        .checklist-help {
            margin: 0 0 1rem 0;
            color: #6c757d;
            font-size: 0.95rem;
        }
        .checklist-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 0.75rem;
        }
        #prep-checklist fieldset {
            margin: 0;
            padding: 0.85rem 0.9rem 1rem;
            border: 1px solid #e9ecef;
            border-radius: 8px;
        }
        #prep-checklist legend {
            padding: 0 0.35rem;
            margin-left: -0.35rem;
            font-weight: 600;
            color: #2c3e50;
        }
        .yn-group {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
            flex-wrap: wrap;
        }
        .yn-option {
            display: inline-flex;
            align-items: center;
            position: relative;
        }
        .yn-option input {
            position: absolute;
            inset: 0;
            opacity: 0;
            pointer-events: none;
        }
        .yn-option span {
            display: inline-block;
            padding: 0.45rem 0.9rem;
            border: 1px solid #e9ecef;
            border-radius: 9999px;
            background: #fff;
            color: #495057;
            font-weight: 600;
            cursor: pointer;
            user-select: none;
            transition: background 0.2s ease, color 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .yn-option:hover span {
            border-color: #cfd4da;
        }
        .yn-option input:focus + span {
            outline: 3px solid rgba(52, 152, 219, 0.35);
            outline-offset: 1px;
        }
        .yn-option input:checked + span {
            background: #e9f3fb;
            border-color: #3498db;
            color: #2c3e50;
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.18);
        }
        .yn-option input[value="yes"]:checked + span {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
            box-shadow: 0 2px 8px rgba(39, 174, 96, 0.18);
        }
        .checklist-status {
            margin-top: 0.9rem;
            font-size: 0.95rem;
            color: #6c757d;
        }
        .ready-message {
            margin-top: 0.6rem;
            padding: 0.75rem 1rem;
            border-radius: 6px;
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        /* Preparation table */
        .table-wrap {
            margin-top: 1rem;
            margin-bottom: 1.5rem;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        .prep-table {
            width: 100%;
            border-collapse: collapse;
            background: #ffffff;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            overflow: hidden;
            font-size: 0.95rem;
        }
        .prep-table caption {
            caption-side: top;
            text-align: left;
            font-weight: 700;
            color: #2c3e50;
            padding: 0.75rem 1rem;
        }
        .prep-table thead th {
            background: #f8f9fa;
            color: #2c3e50;
            font-weight: 700;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e9ecef;
        }
        .prep-table tbody td {
            padding: 0.75rem 1rem;
            border-top: 1px solid #f1f3f5;
            vertical-align: top;
        }
        .prep-table tbody tr:nth-child(odd) td {
            background: #fcfcfd;
        }
        /* Subtle column cues: green for Allowed, red for Not Allowed */
        .prep-table thead th:first-child {
            background: #f3fbf6; /* light green tint */
            border-left: 4px solid #27ae60;
        }
        .prep-table thead th:last-child {
            background: #fff5f5; /* light red tint */
            border-left: 4px solid #e74c3c;
        }
        .prep-table tbody td:first-child {
            border-left: 4px solid #27ae60;
        }
        .prep-table tbody td:last-child {
            border-left: 4px solid #e74c3c;
        }

        .step-icon {
            width: 60px;
            height: 60px;
            background: #3498db;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
            transition: transform 0.25s ease, box-shadow 0.25s ease, background 0.25s ease;
            will-change: transform;
        }
        .prep-step:hover .step-icon,
        .prep-step:focus-within .step-icon {
            transform: scale(1.06);
            background: #3aa0e0;
            box-shadow: 0 6px 18px rgba(52, 152, 219, 0.25), 0 0 0 6px rgba(52, 152, 219, 0.12);
        }

        /* Extras Section */
        .extras-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }

        .extra-service {
            background: white;
            border-radius: 10px;
            padding: 2rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .extra-service:hover {
            transform: translateY(-3px);
        }

        .extra-service h4 {
            color: #3498db;
            margin-bottom: 1rem;
        }

        /* Extras - Tool Directory Card */
        .extra-tool {
            padding: 0;
            overflow: hidden;
            border: 2px solid transparent;
            transition: transform 0.25s ease, border-color 0.25s ease, box-shadow 0.25s ease;
        }
        .extra-tool:hover {
            border-color: #3498db;
            box-shadow: 0 8px 20px rgba(0,0,0,0.12);
        }
        .extra-preview {
            display: block;
            background: #f1f3f5;
            border-bottom: 1px solid #e9ecef;
        }
        .extra-preview img {
            display: block;
            width: 100%;
            aspect-ratio: 16 / 9;
            object-fit: cover;
        }
        .extra-body {
            padding: 1.35rem 1.5rem 1.5rem;
        }
        .extra-title {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 800;
            color: #2c3e50;
        }
        .extra-desc {
            margin: 0.65rem 0 0;
            color: #495057;
            font-size: 0.98rem;
            line-height: 1.7;
        }
        .extra-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.85rem;
        }
        .extra-tag {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.25rem 0.6rem;
            border-radius: 9999px;
            background: #eef2ff;
            border: 1px solid #bfdbfe;
            color: #1e3a8a;
            font-weight: 700;
            font-size: 0.78rem;
            letter-spacing: 0.01em;
        }
        .extra-actions {
            display: flex;
            align-items: center;
            gap: 0.65rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }
        .btn-primary {
            display: inline-block;
            background: #3498db;
            color: #fff;
            padding: 0.65rem 1.05rem;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 700;
            border: none;
            cursor: pointer;
            transition: background 0.2s ease, transform 0.15s ease, box-shadow 0.2s ease;
        }
        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-1px);
            box-shadow: 0 8px 18px rgba(52, 152, 219, 0.25);
        }
        .btn-primary:focus {
            outline: 3px solid rgba(52, 152, 219, 0.35);
            outline-offset: 2px;
        }

        /* Modal (Extras Learn More) */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.72);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
            z-index: 2500; /* above lightbox (2000), below toasts (3000) */
        }
        .modal-overlay.show { display: flex; }
        .modal {
            width: min(960px, 94vw);
            max-height: 85vh;
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 18px 50px rgba(0,0,0,0.35);
            overflow: hidden;
            border: 1px solid rgba(0,0,0,0.10);
        }
        .modal-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 1rem;
            padding: 1rem 1.2rem;
            border-bottom: 1px solid #e9ecef;
            background: rgba(255, 255, 255, 0.98);
        }
        .modal-title {
            margin: 0;
            font-size: 1.2rem;
            font-weight: 800;
            color: #2c3e50;
        }
        .modal-subtitle {
            margin: 0.25rem 0 0;
            color: #6c757d;
            font-size: 0.95rem;
        }
        .modal-close {
            appearance: none;
            -webkit-appearance: none;
            border: none;
            background: #f1f3f5;
            color: #2c3e50;
            width: 40px;
            height: 40px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 18px;
            font-weight: 800;
            flex: 0 0 auto;
            transition: background 0.15s ease, transform 0.1s ease;
        }
        .modal-close:hover { background: #e9ecef; }
        .modal-close:active { transform: scale(0.98); }
        .modal-close:focus { outline: 3px solid rgba(52, 152, 219, 0.35); outline-offset: 2px; }

        .modal-content {
            padding: 1.1rem 1.2rem 1.2rem;
            overflow: auto;
            max-height: calc(85vh - 74px);
        }
        .modal-grid {
            display: grid;
            grid-template-columns: 1.35fr 1fr;
            gap: 1rem;
            align-items: start;
        }
        .modal-media {
            background: #0b1220;
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid rgba(0,0,0,0.08);
        }
        .modal-media video {
            display: block;
            width: 100%;
            aspect-ratio: 16 / 9;
            background: #0b1220;
        }
        .modal-caption {
            margin: 0.6rem 0 0;
            color: #6c757d;
            font-size: 0.9rem;
        }
        .modal-panel {
            background: #fcfcfd;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 0.9rem 0.95rem;
        }
        .modal-panel h4 {
            margin: 0.7rem 0 0.35rem;
            color: #2c3e50;
            font-size: 1rem;
        }
        .modal-panel h4:first-child { margin-top: 0; }
        .modal-panel p {
            margin: 0.25rem 0 0;
            color: #495057;
            line-height: 1.65;
            font-size: 0.95rem;
        }
        .modal-panel ul {
            margin: 0.35rem 0 0;
            padding-left: 1.1rem;
            color: #495057;
            line-height: 1.6;
            font-size: 0.95rem;
        }
        .modal-panel li { margin: 0.25rem 0; }
        .modal-footer {
            display: flex;
            gap: 0.65rem;
            justify-content: flex-end;
            flex-wrap: wrap;
            margin-top: 1rem;
        }
        @media (max-width: 860px) {
            .modal-grid { grid-template-columns: 1fr; }
            .modal-content { padding: 1rem; }
        }

        /* Form Section */
        .form-container {
            background: white;
            border-radius: 10px;
            padding: 3rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-top: 2rem;
        }

        /* Form section cards */
        .form-card {
            background: #ffffff;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.06);
            margin-bottom: 1.5rem;
        }

        .form-section-title {
            margin: 0 0 1rem 0;
            font-size: 1.35rem;
            font-weight: 700;
            color: #2c3e50;
            border-left: 4px solid #3498db;
            padding-left: 0.5rem;
        }

        .form-section-help {
            margin: -0.25rem 0 1rem 0;
            color: #6c757d;
            font-size: 0.95rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-group label {
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 0.75rem;
            border: 2px solid #e9ecef;
            border-radius: 5px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 120px;
        }

        .file-upload {
            border: 2px dashed #e9ecef;
            border-radius: 5px;
            padding: 2rem;
            text-align: center;
            transition: border-color 0.3s ease;
            cursor: pointer;
        }

        .file-upload:hover {
            border-color: #3498db;
        }

        .submit-button {
            background: #3498db;
            color: white;
            padding: 1rem 2rem;
            border: none;
            border-radius: 5px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 2rem;
        }

        .submit-button:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        

        /* Footer */
        .footer {
            background: #2c3e50;
            color: white;
            padding: 3rem 0 1rem;
            margin-top: 4rem;
        }

        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
        }

        .footer-section h4 {
            color: #3498db;
            margin-bottom: 1rem;
        }

        .footer-section p,
        .footer-section a {
            color: #bdc3c7;
            text-decoration: none;
            line-height: 1.8;
        }

        .footer-section a:hover {
            color: #3498db;
        }

        .footer-bottom {
            text-align: center;
            padding-top: 2rem;
            margin-top: 2rem;
            border-top: 1px solid #34495e;
            color: #95a5a6;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .hero h1 {
                font-size: 2rem;
            }

            .about-grid {
                grid-template-columns: 1fr;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .calc-row {
                grid-template-columns: 1fr;
            }

            .nav-container {
                padding: 0 1rem;
            }

            .main-content {
                padding: 0 1rem 6rem;
            }

            .nav-button-text {
                font-size: 0.6rem;
            }

            .team-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Page Navigation */
        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        /* Smooth scrolling */
        html {
            scroll-behavior: smooth;
        }

        /* Error states */
        .error {
            border-color: #e74c3c !important;
        }

        .error-message {
            color: #e74c3c;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 1rem;
            border-radius: 5px;
            margin-top: 1rem;
            border: 1px solid #c3e6cb;
        }
        /* Toasts (auto-dismiss messages) */
        .toast-container {
            position: fixed;
            top: 72px; /* below fixed header */
            left: 50%;
            transform: translateX(-50%);
            z-index: 3000; /* above lightbox (2000) and header (1000) */
            pointer-events: none;
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 0 12px;
            width: min(92vw, 640px);
        }
        .toast {
            pointer-events: auto;
            border-radius: 8px;
            padding: 10px 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.18);
            border: 1px solid rgba(0,0,0,0.06);
            color: #1f2937;
            background: #ffffff;
            font-size: 0.95rem;
            opacity: 0;
            transform: translateY(-6px);
            transition: opacity 150ms ease, transform 150ms ease;
        }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast.error { background: #fde8e9; color: #721c24; border-color: #f5c6cb; }
        .toast.info { background: #eef2ff; color: #1e3a8a; border-color: #bfdbfe; }
        .toast.success { background: #d4edda; color: #155724; border-color: #c3e6cb; }
        /* Google Sign-In (email verification) */
        .google-login { margin-top: 0.35rem; }
        #google-login-status { font-size: 0.9rem; color: #6c757d; margin-top: 0.25rem; }
        #google-login-status.status-success { color: #155724; }
        #google-login-status.status-error { color: #721c24; }
        input[readonly] { background: #f8f9fa; }
        /* Expanded Other expectation input */
        #other-expectation {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e9ecef;
            border-radius: 5px;
            font-size: 1rem;
            box-sizing: border-box;
        }
        #other-expectation:focus {
            outline: none;
            border-color: #3498db;
        }
        /* Gallery under Our Services */
        .samples-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        .sample-thumb {
            width: 100%;
            height: clamp(160px, 22vw, 220px);
            object-fit: contain;
            background-color: #f3f3f3;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            cursor: zoom-in;
            display: block;
        }
        .sample-thumb:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 18px rgba(0,0,0,0.12);
        }
        .sample-thumb:focus {
            outline: 3px solid #3498db;
            outline-offset: 2px;
        }
        /* Lightbox */
        .lightbox {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            z-index: 2000; /* above header/bottom nav (1000) */
        }
        .lightbox-img {
            max-width: 90vw;
            max-height: 85vh;
            border-radius: 8px;
            box-shadow: 0 12px 28px rgba(0,0,0,0.35);
        }
        .lightbox-nav,
        .lightbox-close {
            position: absolute;
            background: rgba(0,0,0,0.6);
            color: #fff;
            border: none;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s ease, transform 0.1s ease;
        }
        .lightbox-nav:hover,
        .lightbox-close:hover { background: rgba(0,0,0,0.75); }
        .lightbox-nav:active,
        .lightbox-close:active { transform: scale(0.96); }
        .lightbox-prev { left: 1rem; top: 50%; transform: translateY(-50%); }
        .lightbox-next { right: 1rem; top: 50%; transform: translateY(-50%); }
        .lightbox-close { top: 1rem; right: 1rem; }
        @media (max-width: 768px) {
            .sample-thumb { height: 160px; }
        }
    </style>
    <!-- Google Identity Services for Sign-In -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <nav class="nav-container">
            <div class="brand" aria-label="i-Nano Research Facility">
                <span class="logo">
                    <img src="Images/inanoresearchfacilityDLSUlogo.png" alt="i-Nano Research Facility logo" />
                </span>
                <span class="brand-text">i‑Nano Research Facility</span>
            </div>
        </nav>
    </header>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <div class="nav-buttons">
            <a href="#" class="nav-button" data-section="about">
                <div class="nav-button-icon">🔬</div>
                <div class="nav-button-text">About</div>
            </a>
            <a href="#" class="nav-button" data-section="cost">
                <div class="nav-button-icon">🧮</div>
                <div class="nav-button-text">Cost of Analysis</div>
            </a>
            <a href="#" class="nav-button" data-section="request">
                <div class="nav-button-icon">📝</div>
                <div class="nav-button-text">Service Request</div>
            </a>
            <a href="#" class="nav-button" data-section="preparation">
                <div class="nav-button-icon">⚗️</div>
                <div class="nav-button-text">Sample Prep</div>
            </a>
            <a href="#" class="nav-button" data-section="extras">
                <div class="nav-button-icon">🔧</div>
                <div class="nav-button-text">Extras</div>
            </a>
        </div>
    </nav>

    <!-- Hero Section removed -->

    <!-- Main Content -->
    <main class="main-content">
        <!-- About Page -->
        <div id="about-page" class="page active">
            <section class="section">
                <h2>About Our Laboratory</h2>
                <div class="about-grid">
                    <div class="about-text">
                        <p>The i-Nano Research Facility, located at De La Salle University Manila, provides cutting-edge analytical services using state-of-the-art scanning electron microscopy (SEM) and energy-dispersive X-ray spectroscopy (EDX) equipment.</p>
                        <p>With over 15 years of experience in materials characterization, our team of expert analysts delivers precise, reliable results for academic research, industrial R&D, and quality control applications.</p>
                        <p>We specialize in surface morphology analysis, elemental composition mapping, failure analysis, and contamination identification across a wide range of materials including metals, ceramics, polymers, and composites.</p>
                    </div>
                    <div>
                        <h3 class="team-heading">🔬 Expert Team</h3>
                        <div class="team-grid" role="list">
                            <div class="team-card" role="listitem">
                                <img class="team-photo" src="Images/noni.png" alt="Portrait of Dr. Gil Nonato Santos, Lab Head" loading="lazy" decoding="async" width="112" height="112" onerror="this.onerror=null; this.src='Images/blankprofile.png';">
                                <div class="team-name">Dr. Gil Nonato Santos</div>
                                <div class="team-role">Lab Head</div>
                            </div>
                            <div class="team-card" role="listitem">
                                <img class="team-photo" src="Images/olarve.png" alt="Portrait of Dr. James Salveo Olarve, Lab Coordinator" loading="lazy" decoding="async" width="112" height="112" onerror="this.onerror=null; this.src='Images/blankprofile.png';">
                                <div class="team-name">Dr. James Salveo Olarve</div>
                                <div class="team-role">Lab Coordinator</div>
                            </div>
                            <div class="team-card" role="listitem">
                                <img class="team-photo" src="Images/gerard.png" alt="Portrait of Mr. Anthony Gerard Santos, Lab Specialist" loading="lazy" decoding="async" width="112" height="112" onerror="this.onerror=null; this.src='Images/blankprofile.png';">
                                <div class="team-name">Mr. Anthony Gerard Santos</div>
                                <div class="team-role">Lab Specialist</div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            <!-- Our Services Cards -->
            <section class="section">
                <h3 class="team-heading">🧪 Our Services</h3>
                <div class="pricing-grid">
                    <div class="pricing-card service-card">
                        <img class="service-header" src="Images/headerSEM.png" alt="Basic SEM service header" loading="lazy" decoding="async" onerror="this.onerror=null; this.style.display='none';">
                        <h3>SEM</h3>
                        <p style="font-size: 0.95rem; color: #6c757d; margin: -0.25rem 0 0.75rem;">Scanning Electron Microscopy: Surface Morphology</p>
                    </div>
                    <div class="pricing-card service-card">
                        <img class="service-header" src="Images/headerSEMEDX.png" alt="SEM and EDX service header" loading="lazy" decoding="async" onerror="this.onerror=null; this.style.display='none';">
                        <h3>EDS/EDX</h3>
                        <p style="font-size: 0.95rem; color: #6c757d; margin: -0.25rem 0 0.75rem;">Energy Dispersive X-ray Spectroscopy: Elemental Composition</p>
                    </div>
                </div>
                <!-- Sample Images Gallery -->
                <h4 class="team-heading" style="margin-top: 1.5rem;">🖼️ Sample Micrographs and Elemental Compositions</h4>
                <p style="font-size: 0.95rem; color: #6c757d; margin: -0.5rem 0 1rem;">
                    A few representative SEM micrographs and EDX results from our lab. Click to enlarge.
                </p>
                <div id="samples-grid" class="samples-grid" aria-live="polite"></div>
                
                <!-- Download Sample Raw Data -->
                <h4 class="team-heading" style="margin-top: 1.5rem;">📥 Sample Raw Data</h4>
                <div class="extra-service" id="raw-data-download">
                    <p style="margin-top: 0; color: #6c757d;">
                        Download a sample package containing SEM micrographs and EDX outputs (images, spectrum, and document report data).
                    </p>
                    <!-- TODO: Replace href with your Google Drive folder link -->
                    <a class="btn-subtle" href="https://drive.google.com/drive/folders/1Z2xSd-d935kg6bFXfIpvtg8A_0EWd5Td?usp=sharing" target="_blank" rel="noopener noreferrer"
                       aria-label="Download sample SEM and EDX raw data from Google Drive">
                        Download Sample Raw Data
                    </a>
                </div>

                <!-- Feedback Section -->
                <h4 class="team-heading" id="feedback-title" style="margin-top: 1.5rem;">💬 Feedback</h4>
                <div class="extra-service" id="feedback-section" role="region" aria-labelledby="feedback-title">
                    <p style="margin-top:0; color:#6c757d; font-size:0.95rem;">
                        We’d love your feedback! Was our service helpful, timely, and clear? Share your experience below. This embed loads Facebook’s Comments widget (third‑party) which may set cookies. Viewers are subject to Facebook’s <a href="https://www.facebook.com/policy.php" target="_blank" rel="noopener noreferrer">Privacy Policy</a>.
                    </p>
                    <div id="fb-root"></div>
                    <div class="fb-comments" id="feedback-comments" data-href="https://phenom-dlsu.weebly.com/" data-width="" data-numposts="7"></div>
                </div>
            </section>
        </div>

        <!-- Cost Analysis Page -->
        <div id="cost-page" class="page">
            <section class="section">
                <h2>Cost of Analysis</h2>
                <div class="pricing-grid">
                    <div class="pricing-card">
                        <h3>Basic SEM</h3>
                        <img class="service-header" src="Images/basicsem.png" alt="Basic SEM illustrative micrograph" loading="lazy" decoding="async" onerror="this.onerror=null; this.style.display='none';">
                        <p style="font-size: 0.95rem; color: #6c757d; margin: -0.25rem 0 0.75rem;">Scanning Electron Microscopy: Surface Morphology</p>
                        <ul class="pricing-features">
                            <li>High-quality images</li>
                            <li>Imaging of up to 3 areas on the sample</li>
                            <li>Minimum of 12 SEM images</li>
                            <li>Multiple magnifications (500×–30,000× or higher, as needed)</li>
                            <li>Raw data files delivered via email</li>
                            <li>Quick turnaround (depending on the availability of our scientists)</li>
                            <li>Official Certification of Analysis</li>

                        </ul>
                    </div>
                    <div class="pricing-card">
                        <h3>SEM and EDX</h3>
                        <img class="service-header" src="Images/semandedx.png" alt="SEM and EDX micrograph and spectrum example" loading="lazy" decoding="async" onerror="this.onerror=null; this.style.display='noneowi';">
                        <p style="font-size: 0.95rem; color: #6c757d; margin: -0.25rem 0 0.75rem;">
                            Scanning Electron Microscopy: Surface Morphology<br>
                            Energy Dispersive X-ray Spectroscopy: Elemental Composition
                        </p>
                        <ul class="pricing-features">
                            <li>Same with Basic SEM plus the folowing</li>
                            <li>Elemental analysis (EDX) of 3 different areas on the sample</li>
                            <li>Quantitative concentration: Atomic and Weight</li>
                            <li>EDS graph spectrum showing characteristic peaks</li>
                            <li>Elemental mapping</li>
                            <li>Detailed report included (docx)</li>
                            <li>Official Certification of Analysis</li>
                        </ul>
                    </div>
                </div>

                <!-- Cost Calculator -->
                <div class="calculator">
                    <h3>🧮 Cost Calculator</h3>
                    <div class="calc-row">
                        <div class="calc-input">
                            <label for="samples">Number of Samples:</label>
                            <input type="number" id="samples" min="1" max="100" value="1" aria-describedby="bulk-pricing-hint">
                            <input type="range" id="samples-slider" min="1" max="100" step="1" value="1" aria-label="Samples slider" aria-describedby="bulk-pricing-hint">
                            <p id="bulk-pricing-hint" class="calc-help">Bulk pricing: the average cost per sample decreases as sample count increases.</p>
                        </div>
                        <div class="calc-input">
                            <label for="analysis-type">Analysis Type:</label>
                            <select id="analysis-type">
                                <option value="basic">Basic SEM</option>
                                <option value="semedx">SEM and EDX</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="calc-result">
                        <div class="calc-total">Total Cost ₱<span id="total-cost">—</span></div>
                    </div>
                </div>
            </section>
        </div>

        <!-- Sample Preparation Page -->
        <div id="preparation-page" class="page">
            <section class="section">
                <h2>Sample Preparation Guidelines</h2>
                <p class="section-subtitle">Proper sample preparation is essential for obtaining high-quality SEM and EDX results. Only solid, fully dried samples are accepted to ensure safety and prevent instrument contamination. Each sample should be small, clean, and securely packaged in a labeled container. Following these preparation guidelines helps achieve accurate imaging, reliable elemental analysis, and smooth processing of your request.</p>
                <div class="table-wrap" aria-label="Allowed vs. Not Allowed Samples table">
                    <table class="prep-table">
                        <caption>Allowed vs. Not Allowed Samples for SEM-EDX Analysis</caption>
                        <thead>
                            <tr>
                                <th scope="col">Allowed Samples (Solid Only)</th>
                                <th scope="col">Not Allowed Samples</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Powders / powder-like materials</td>
                                <td>Liquids</td>
                            </tr>
                            <tr>
                                <td>Rock-like or mineral samples</td>
                                <td>Gases</td>
                            </tr>
                            <tr>
                                <td>Glass pieces</td>
                                <td>Samples containing mercury</td>
                            </tr>
                            <tr>
                                <td>Plastics / polymers</td>
                                <td>Radioactive materials</td>
                            </tr>
                            <tr>
                                <td>Organic solids (wood, leaves, seeds)</td>
                                <td>Biological hazards (blood, tissue, pathogens)</td>
                            </tr>
                            <tr>
                                <td>Insects (dry and preserved)</td>
                                <td>Toxic or highly hazardous materials</td>
                            </tr>
                            <tr>
                                <td>Teeth / bone fragments</td>
                                <td>Corrosive chemicals or strongly reactive materials</td>
                            </tr>
                            <tr>
                                <td>Rubber pieces</td>
                                <td>Wet, moist, or damp samples</td>
                            </tr>
                            <tr>
                                <td>Paper / cardboard</td>
                                <td>Samples that may outgas or contaminate the chamber</td>
                            </tr>
                            <tr>
                                <td>Textiles / fabric</td>
                                <td>Sticky, oily, or adhesive substances</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="prep-steps">
                    <div class="prep-step">
                        <div class="step-icon">1</div>
                        <h4>Sample Mass & Size</h4>
                        <img class="prep-photo" src="Images/samplemasssize.png" alt="Sample mass and size example" loading="lazy" decoding="async" onerror="this.onerror=null; this.style.display='none';">
                        <p>For best imaging and EDX analysis, submit small, solid samples. A typical sample should have a surface area of around 1 cm² and a thickness of a few millimeters. Only a small amount of material is required—an ideal mass is just a few milligrams (≈ 5 mg).</p>
                    </div>
                    <div class="prep-step">
                        <div class="step-icon">2</div>
                        <h4>Drying</h4>
                        <img class="prep-photo" src="Images/drying.png" alt="Drying samples before analysis" loading="lazy" decoding="async" onerror="this.onerror=null; this.style.display='none';">
                        <p>Samples must be completely dry to prevent contamination, outgassing, or damage to the equipment. Samples may be dried using methods such as air drying or sun drying, or through laboratory techniques like oven drying and freeze drying depending on your sample's characteristics. Ensuring samples are thoroughly dried helps achieve high-quality imaging and accurate elemental results.</p>
                    </div>
                    <div class="prep-step">
                        <div class="step-icon">3</div>
                        <h4>Packaging and Label</h4>
                        <img class="prep-photo" src="Images/packaginglabel.png" alt="Packaging and labeling of samples" loading="lazy" decoding="async" onerror="this.onerror=null; this.style.display='none';">
                        <p>Ensure all samples are placed in clean and secure containers. Each container must be tightly sealed to prevent spills or contamination. Label every sample clearly with your name and sample code for easy identification.</p>
                    </div>
                </div>
                <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px; padding: 1.5rem; margin-top: 2rem;">
                    <h4 style="color: #856404; margin-bottom: 1rem;">⚠️ Important Note:</h4>
                    <ul style="color: #856404; margin: 0;">
                        <li>Contact us for guidance on unusual sample types.<br>Email: admin@inanolab.com<br>Mobile: 09298051084</li>
                    </ul>
                </div>

                <!-- Quick Readiness Checklist -->
                <div id="prep-checklist" class="checklist-card" role="region" aria-labelledby="prep-checklist-title">
                    <h3 id="prep-checklist-title">Quick Readiness Checklist</h3>
                    <p class="checklist-help">Confirm your samples meet the basic requirements before submitting a request.</p>
                    <div class="checklist-grid">
                        <fieldset>
                            <legend>Are your samples solid?</legend>
                            <div class="yn-group">
                                <label class="yn-option">
                                    <input type="radio" name="chk-solid" value="yes">
                                    <span>Yes</span>
                                </label>
                                <label class="yn-option">
                                    <input type="radio" name="chk-solid" value="no">
                                    <span>No</span>
                                </label>
                            </div>
                        </fieldset>
                        <fieldset>
                            <legend>Are your samples small?</legend>
                            <div class="yn-group">
                                <label class="yn-option">
                                    <input type="radio" name="chk-small" value="yes">
                                    <span>Yes</span>
                                </label>
                                <label class="yn-option">
                                    <input type="radio" name="chk-small" value="no">
                                    <span>No</span>
                                </label>
                            </div>
                        </fieldset>
                        <fieldset>
                            <legend>Are your samples dried thoroughly?</legend>
                            <div class="yn-group">
                                <label class="yn-option">
                                    <input type="radio" name="chk-dried" value="yes">
                                    <span>Yes</span>
                                </label>
                                <label class="yn-option">
                                    <input type="radio" name="chk-dried" value="no">
                                    <span>No</span>
                                </label>
                            </div>
                        </fieldset>
                        <fieldset>
                            <legend>Are your samples packed properly?</legend>
                            <div class="yn-group">
                                <label class="yn-option">
                                    <input type="radio" name="chk-packed" value="yes">
                                    <span>Yes</span>
                                </label>
                                <label class="yn-option">
                                    <input type="radio" name="chk-packed" value="no">
                                    <span>No</span>
                                </label>
                            </div>
                        </fieldset>
                        <fieldset>
                            <legend>Are your samples labeled properly?</legend>
                            <div class="yn-group">
                                <label class="yn-option">
                                    <input type="radio" name="chk-labeled" value="yes">
                                    <span>Yes</span>
                                </label>
                                <label class="yn-option">
                                    <input type="radio" name="chk-labeled" value="no">
                                    <span>No</span>
                                </label>
                            </div>
                        </fieldset>
                    </div>
                    <p class="checklist-status" aria-live="polite">0/5 Yes selected</p>
                    <div class="ready-message" hidden>✅ All set! Your samples appear ready for submission.</div>
                </div>
            </section>
        </div>

        <!-- Extras Page -->
        <div id="extras-page" class="page">
            <section class="section">
                <h2>Extras</h2>
                <p class="section-subtitle">Useful applications and resources for researchers. Tools open as separate pages within this site.</p>

                <div class="extras-grid" aria-label="Research tools">
                    <article class="extra-service extra-tool">
                        <a class="extra-preview" href="micromeasure.html" aria-label="Open MicroMeasure">
                            <img src="Images/micromeasure.png" alt="MicroMeasure preview" loading="lazy">
                        </a>
                        <div class="extra-body">
                            <h3 class="extra-title">MicroMeasure</h3>
                            <p class="extra-desc">Looking for a fast and reliable way to measure features in your microscopy images without installing complex software? MicroMeasure is a browser-based scientific image analysis tool that allows researchers to perform calibrated length and area measurements, as well as automated particle and hole (pore) analysis, directly from their web browser. It combines essential image-analysis capabilities with an intuitive interface and transparent measurement methods, enabling reproducible, real-unit measurements suitable for research, teaching, and documentation. By reducing technical barriers and simplifying workflows, MicroMeasure offers a practical and accessible alternative for laboratories, educators, and students who need accurate quantitative image analysis anytime, anywhere.</p>
                            <div class="extra-tags" aria-label="MicroMeasure tags">
                                <span class="extra-tag">Browser-based</span>
                                <span class="extra-tag">Microscopy</span>
                                <span class="extra-tag">Image analysis</span>
                                <span class="extra-tag">Measurements</span>
                            </div>
                            <div class="extra-actions">
                                <a class="btn-primary" href="micromeasure.html">Open MicroMeasure</a>
                                <button class="btn-subtle" type="button" data-open-modal="micromeasure" aria-haspopup="dialog">Learn more</button>
                            </div>
                        </div>
                    </article>
                </div>
            </section>
        </div>

        <!-- Service Request Page -->
        <div id="request-page" class="page">
            <section class="section">
                <h2>Service Request Form</h2>
                <div id="promo-banner" class="promo-banner" role="note" aria-live="polite">
                    <span>Holiday Promo: 10% off with code <strong>student</strong>. Enter it in the Voucher Code below.</span>
                    <button type="button" class="promo-dismiss" aria-label="Dismiss promotion">×</button>
                </div>
                <form id="service-form" novalidate>
                        <!-- A. Requestee Information -->
                        <div class="form-card">
                            <h3 class="form-section-title">A. Requestee Information</h3>
                            <p class="form-section-help">Please provide your complete contact and institutional details. This information will be used for communication, documentation, and issuing official records.</p>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="full-name">Full Name *</label>
                                    <input type="text" id="full-name" name="fullName" required>
                                </div>
                                <div class="form-group">
                                    <label for="email">Email Address *</label>
                                    <input type="email" id="email" name="email" required readonly>
                                    <div id="google-login-area" class="google-login">
                                        <div id="google-login-btn"></div>
                                        <div id="google-login-status">Use Google Sign-In to verify your email.</div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="mobile-number">Mobile Number *</label>
                                    <input type="tel" id="mobile-number" name="mobileNumber" required inputmode="tel" pattern="^[+0-9()\-\s]{7,20}$" title="Enter a valid phone number: digits and + - ( ) spaces only (7–20 chars)">
                                </div>
                                <div class="form-group">
                                    <label for="position">Position/Designation *</label>
                                    <select id="position" name="position" required onchange="toggleOtherPosition()">
                                        <option value="">Select your position</option>
                                        <option value="high-school-student">High School Student</option>
                                        <option value="college-student">College Student</option>
                                        <option value="graduate-student">Graduate Student</option>
                                        <option value="researcher">Researcher</option>
                                        <option value="teacher">Teacher</option>
                                        <option value="instructor">Instructor</option>
                                        <option value="professor">Professor</option>
                                        <option value="adviser">Adviser</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                                <div class="form-group" id="other-position-group" style="display: none;">
                                    <label for="other-position">Please specify your position *</label>
                                    <input type="text" id="other-position" name="otherPosition">
                                </div>
                                <div class="form-group">
                                    <label for="school-name">Name of School / Company / Organization *</label>
                                    <input type="text" id="school-name" name="schoolName" required>
                                </div>
                                <div class="form-group full-width">
                                    <label for="school-address">Address of School / Company / Organization *</label>
                                    <textarea id="school-address" name="schoolAddress" rows="3" required></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- B. Requested Services -->
                        <div class="form-card">
                            <h3 class="form-section-title">B. Requested Services</h3>
                            <p class="form-section-help">Select the type of analysis you require and provide details about your samples and preferred schedule. This helps us plan the procedure and estimate the turnaround time.</p>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Kind of Characterization *</label>
                                    <div style="margin-top: 0.5rem;">
                                        <p style="font-size: 0.9rem; color: #6c757d; margin-bottom: 1rem;">
                                            SEM - Surface Morphology (Scanning Electron Microscope)<br>
                                            EDX - Elemental Analysis (Energy Dispersive X-Ray)
                                        </p>
                                        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                            <label style="display: flex; align-items: center; font-weight: normal;">
                                                <input type="radio" name="characterization" value="sem-only" required style="margin-right: 0.5rem;" checked>
                                                SEM only
                                            </label>
                                            <label style="display: flex; align-items: center; font-weight: normal;">
                                                <input type="radio" name="characterization" value="sem-and-edx" required style="margin-right: 0.5rem;">
                                                SEM and EDX
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="sample-count">Number of Samples *</label>
                                    <input type="number" id="sample-count" name="sampleCount" min="1" value="1" required>
                                </div>
                                <div class="form-group">
                                    <label>Are your samples conductive? *</label>
                                    <div style="display: flex; gap: 1rem; margin-top: 0.5rem;">
                                        <label style="display: flex; align-items: center; font-weight: normal;">
                                            <input type="radio" name="conductive" value="yes" required style="margin-right: 0.5rem;">
                                            Yes
                                        </label>
                                        <label style="display: flex; align-items: center; font-weight: normal;">
                                            <input type="radio" name="conductive" value="no" required style="margin-right: 0.5rem;">
                                            No
                                        </label>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="delivery-date">Date to Deliver the Samples *</label>
                                    <input type="date" id="delivery-date" name="deliveryDate" required>
                                </div>
                                <div class="form-group">
                                    <label for="turnaround">Allowance for the turnover of results *</label>
                                    <p style="font-size: 0.9rem; color: #6c757d; margin: 0.25rem 0 0.5rem;">Select the preferred time window for receiving your results.</p>
                                    <select id="turnaround" name="turnaround" required>
                                        <option value="">Select turnaround time</option>
                                        <option value="2-3-days">2-3 days</option>
                                        <option value="5-days">5 days</option>
                                        <option value="1-week">1 week</option>
                                        <option value="2-weeks">2 weeks</option>
                                    </select>
                                </div>
                            </div>
                            <div class="calc-result" style="margin-top: 0.5rem;">
                                <div class="calc-total">Total Cost ₱<span id="services-total-cost">—</span></div>
                            </div>
                        </div>

                        <!-- C. Sample Characteristics -->
                        <div class="form-card">
                            <h3 class="form-section-title">C. Sample Characteristics &amp; Research Requirements</h3>
                            <p class="form-section-help">Describe your sample and specify your research objectives. Clear and accurate information ensures we perform the SEM/EDX analysis according to your expectations.</p>
                            <div class="form-grid">
                                <div class="form-group full-width">
                                    <label for="research-objectives">Analysis Objectives *</label>
                                    <p style="font-size: 0.9rem; color: #6c757d; margin: 0.25rem 0 0.5rem;">
                                        What is/are your research objectives related to the surface morphology (and elemental composition) of your sample?
                                    </p>
                                    <textarea id="research-objectives" name="researchObjectives" rows="4" required></textarea>
                                </div>
                                <div class="form-group full-width">
                                    <label for="sample-characteristics">Describe the Characteristics of Your Sample *</label>
                                    <p style="font-size: 0.9rem; color: #6c757d; margin: 0.25rem 0 0.5rem;">
                                        Provide a clear description of your sample’s physical characteristics, such as its appearance, color, texture, and form
                                    </p>
                                    <textarea id="sample-characteristics" name="sampleCharacteristics" rows="3" placeholder="e.g., white powder, dried leaf fragments, tooth specimens"></textarea>
                                </div>
                                <div class="form-group full-width">
                                    <label for="sem-expectations">SEM Micrograph Expectations *</label>
                                    <p style="font-size: 0.9rem; color: #6c757d; margin: 0.25rem 0 0.5rem;">
                                        Select the morphology/features you expect to observe in the SEM micrographs.
                                    </p>
                                    <div style="margin-top: 1rem;">
                                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem;">
                                            <label style="display: flex; align-items: center; font-weight: normal;">
                                                <input type="checkbox" name="expectations" value="nanoparticles" style="margin-right: 0.5rem;">
                                                Nanoparticles
                                            </label>
                                            <label style="display: flex; align-items: center; font-weight: normal;">
                                                <input type="checkbox" name="expectations" value="nanowires" style="margin-right: 0.5rem;">
                                                Nanowires
                                            </label>
                                            <label style="display: flex; align-items: center; font-weight: normal;">
                                                <input type="checkbox" name="expectations" value="microparticles" style="margin-right: 0.5rem;">
                                                Microparticles
                                            </label>
                                            <label style="display: flex; align-items: center; font-weight: normal;">
                                                <input type="checkbox" name="expectations" value="micropores" style="margin-right: 0.5rem;">
                                                Micropores
                                            </label>
                                            <label style="display: flex; align-items: center; font-weight: normal;">
                                                <input type="checkbox" name="expectations" value="nanopores" style="margin-right: 0.5rem;">
                                                Nanopores
                                            </label>
                                            <label style="display: flex; align-items: center; font-weight: normal;">
                                                <input type="checkbox" name="expectations" value="surface-roughness" style="margin-right: 0.5rem;">
                                                Surface Roughness
                                            </label>
                                            <label style="display: flex; align-items: center; font-weight: normal;">
                                                <input type="checkbox" name="expectations" value="surface-structure" style="margin-right: 0.5rem;">
                                                Surface Structure
                                            </label>
                                            <label style="display: flex; align-items: center; font-weight: normal;">
                                                <input type="checkbox" name="expectations" value="other" style="margin-right: 0.5rem;" onchange="toggleOtherExpectation()">
                                                Other
                                            </label>
                                        </div>
                                        <div id="other-expectation-group" style="display: none; margin-top: 1rem;">
                                            <input type="text" id="other-expectation" name="otherExpectation" placeholder="Please specify...">
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group full-width">
                                    <label for="edx-elements">EDX Target Elements *</label>
                                    <p style="font-size: 0.9rem; color: #6c757d; margin: 0.25rem 0 0.5rem;">
                                        If you intend to avail the EDX analysis, then kindly specify the chemical elements that you expect to see.
                                    </p>
                                    <textarea id="edx-elements" name="edxElements" rows="3" placeholder="e.g., Carbon (C), Oxygen (O), Silicon (Si), etc."></textarea>
                                </div>
                                <div class="form-group full-width">
                                    <label>Upload Reference Photos *<br>
                                    <span style="font-size: 0.9rem; color: #6c757d;">Upload reference images to illustrate the features you wish to locate in the SEM micrographs.</span></label>
                                    <div class="file-upload" onclick="document.getElementById('file-input').click()">
                                        <input type="file" id="file-input" multiple accept="image/*,.pdf,.doc,.docx" style="display: none;" required>
                                        <p>📎 Click to upload sample photos and reference images. Please be patient in uploading as it usually takes a while to reflect a successful upload.</p>
                                        <p style="font-size: 0.9rem; color: #6c757d;">Accepted formats: JPG, PNG, PDF, DOC (Max 10MB each)</p>
                                    </div>
                                    <div id="upload-messages" aria-live="polite" style="margin-top:0.5rem;"></div>
                                    <div id="file-list"></div>
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="submit-button">Submit Service Request</button>
                        <div id="form-messages" aria-live="polite"></div>
                </form>
            </section>
        </div>
    </main>
    
    <!-- Lightbox Overlay -->
    <div id="lightbox" class="lightbox" role="dialog" aria-modal="true" aria-label="Sample image viewer" aria-hidden="true">
        <button id="lightbox-close" class="lightbox-close" type="button" aria-label="Close viewer">✕</button>
        <button id="lightbox-prev" class="lightbox-nav lightbox-prev" type="button" aria-label="Previous image">‹</button>
        <img id="lightbox-image" class="lightbox-img" alt="">
        <button id="lightbox-next" class="lightbox-nav lightbox-next" type="button" aria-label="Next image">›</button>
    </div>

    <!-- Extras: Learn More Modal (MicroMeasure) -->
    <div id="modal-micromeasure" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="modal-micromeasure-title" aria-hidden="true">
        <div class="modal" role="document">
            <div class="modal-header">
                <div>
                    <h3 id="modal-micromeasure-title" class="modal-title">MicroMeasure — Quick Tutorial</h3>
                    <p class="modal-subtitle">Watch the short walkthrough and review key features.</p>
                </div>
                <button class="modal-close" type="button" aria-label="Close">✕</button>
            </div>
            <div class="modal-content">
                <div class="modal-grid">
                    <div>
                        <div class="modal-media">
                            <video controls preload="metadata" playsinline poster="Images/micromeasure.png">
                                <source src="Videos/micromeasure.mp4" type="video/mp4">
                                Your browser does not support the video tag.
                            </video>
                        </div>
                        <p class="modal-caption">Tip: Use full screen for small screens.</p>
                    </div>

                    <div class="modal-panel">
                        <h4>About</h4>
                        <p>
                            <strong>Version:</strong> 1.0<br>
                            <strong>Website:</strong> <a href="https://www.inanolab.com/micromeasure.html" target="_blank" rel="noopener">https://www.inanolab.com/micromeasure.html</a><br>
                            <strong>Developer / Programmer:</strong> Dr. James Salveo Olarve<br>
                            <strong>Affiliation:</strong> i-Nano Research Facility, De La Salle University Manila
                        </p>

                        <h4>📚 Citation Recommendation</h4>
                        <p>If you use MicroMeasure in academic work:</p>
                        <p>
                            Olarve, J. S. L. (2026). MicroMeasure: A web-based image analysis and measurement tool. i-Nano Research Facility, De La Salle University Manila. Retrieved from
                            <a href="https://www.inanolab.com/micromeasure.html" target="_blank" rel="noopener">https://www.inanolab.com/micromeasure.html</a>
                        </p>
                        <p><em>(Updated citation will be provided once DOI is assigned.)</em></p>

                        <h4>What MicroMeasure Is</h4>
                        <p>MicroMeasure (implemented almost entirely in <strong>micromeasure.html</strong>) is a browser-based measurement + image-analysis tool aimed at microscopy images (e.g., SEM). It runs fully client-side (no install), drawing the image on one canvas and all annotations/analysis overlays on a second canvas.</p>

                        <h4>Core Workflow Features</h4>
                        <ul>
                            <li><strong>Load image</strong>: via “Load Image” file picker or drag &amp; drop onto the viewer. When no image is loaded, tapping/clicking the viewer triggers the file picker (mobile-friendly).</li>
                            <li><strong>Guided status badge</strong>: walks users through Load an image → Set the scale → Make a measurement, then hides once completed.</li>
                            <li><strong>Help / Documentation modal</strong>: “Help” opens built-in documentation with quick start, tool explanations, shortcuts, and export guidance.</li>
                        </ul>

                        <h4>Navigation (Viewing the Image)</h4>
                        <ul>
                            <li><strong>Zoom</strong>: slider (50–300%), mouse wheel zoom, and mobile pinch behavior.</li>
                            <li><strong>Pan</strong>: buttons (← ↑ ↓ →) + 🎯 reset pan; keyboard arrows; middle-mouse drag or Alt+drag; two-finger drag on touch.</li>
                            <li><strong>Fit to View</strong>: automatically scales/centers the image; re-applies on resize/orientation changes.</li>
                        </ul>

                        <h4>Scale Calibration (Pixel → Real Units)</h4>
                        <ul>
                            <li>Click <strong>Set Scale</strong>, then click two points across a known scale bar.</li>
                            <li>Enter known length and select unit (nm / μm / mm), then save.</li>
                            <li>After calibration, all measurements show px + real units; min-area thresholds switch to real-unit mode.</li>
                        </ul>

                        <h4>Manual Measurement Tools</h4>
                        <ul>
                            <li><strong>Length</strong>: click two points to create L1, L2…; show/hide, edit, delete; “Clear All Lengths”.</li>
                            <li><strong>Area</strong>: click multiple points to define polygon; close to finalize A1, A2…; edit vertices; “Clear All Areas”.</li>
                        </ul>

                        <h4>Automated Analysis Tools</h4>
                        <ul>
                            <li><strong>Particles</strong>: optional ROI, preprocessing, manual/auto thresholding (Otsu), polarity; orange boxes + summary stats + ECD histogram.</li>
                            <li><strong>Holes</strong>: similar workflow tuned for voids; purple boxes + summary stats + ECD histogram.</li>
                        </ul>

                        <h4>Results &amp; Export</h4>
                        <ul>
                            <li><strong>Results tab</strong> consolidates Length/Area/Particle/Hole into one list.</li>
                            <li><strong>Copy TSV</strong> for Excel/Sheets; <strong>Download CSV</strong> for full exports.</li>
                            <li><strong>Save Image</strong> exports PNG with overlays (enabled when applicable).</li>
                            <li><strong>Reset</strong> clears measurements/analysis/ROI and resets calibration (keeps the loaded image).</li>
                        </ul>
                    </div>
                </div>

                <div class="modal-footer">
                    <a class="btn-subtle" href="micromeasure.html">Open MicroMeasure</a>
                    <button class="btn-primary" type="button" data-close-modal>Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-section">
                <h4>Contact Information</h4>
                <p>📧 admin@inanolab.com</p>
                <p>📞 09298051084</p>
                <p>📘 <a href="https://www.facebook.com/SEMEDXbyiNanoResearch/" target="_blank" rel="noopener noreferrer">Facebook Page</a></p>
                <p>📍 Room 113, STRC Building,<br>De La Salle University - Manila</p>
            </div>
            <div class="footer-section">
                <h4>Laboratory Hours (depends on availability)</h4>
                <p>Monday - Friday: 8:00 AM - 5:00 PM</p>
                <p>Saturday: 9:00 AM - 5:00 PM</p>
                <p>Sunday: *Special appointment</p>
                <p>Emergency analysis available by appointment</p>
            </div>
            <div class="footer-section">
                <h4>Institutional Affiliation</h4>
                <p><a href="https://www.dlsu.edu.ph/colleges/cos/departments/physics/" target="_blank" rel="noopener noreferrer">Department of Physics, DLSU-Manila</a></p>
                <p><a href="https://www.papsicenter.com/" target="_blank" rel="noopener noreferrer">Philippine Association of Physics and Science Instructors</a></p>
                <p><a href="https://www.pjmsn.org/" target="_blank" rel="noopener noreferrer">Philippine Journal of Material Science</a></p>
            </div>
            <div class="footer-section">
                <h4>&copy; <span class="current-year"></span> iNanolab.com</h4>
                <p>i-Nano Research Facility</p>
                <p>🖋️ Head Editor: Dr. Gil Nonato Santos</p>
                <p>💻 Head Developer: Dr. James Salveo Olarve</p>
                <p><a href="privacy.html" target="_self" rel="noopener">Privacy Policy</a></p>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; <span class="current-year"></span> i-Nano Research Facility. All rights reserved.</p>
        </div>
    </footer>
    <script>document.querySelectorAll('.current-year').forEach(function(el){ el.textContent = new Date().getFullYear(); });</script>

    <script>
        // Configuration
        // Google Apps Script Web App endpoints & API key
        const GAS_UPLOAD_URL = 'https://script.google.com/macros/s/AKfycbwinVplLmTXIEcp-ekRTnGEwUOpZJgoV7thg1AvJpd5XpMVNxx_EwQifyywLTYHIqlclg/exec';
        const API_KEY = '941E5441B3FC73E61214612443D92'; // Provided key
        // Form submission endpoint (Apps Script Web App router expecting func=addRow)
        // TODO: If you deployed a newer Web App for addRow, update this URL.
        const GAS_FORM_URL = 'https://script.google.com/macros/s/AKfycbwzIILv0oMo2_-cDr5gHc-Tu5jodaVaCmV4v3Dl0Y14-TTYKOH0i37jU_PrWj5M1vvn/exec';
        const FORM_API_KEY = 'BgWFBsc9NAQeyd7DBfkF3qdPR6EdeieB';
        // Client-side state of uploaded files: {fileId, name, size, type}
        const uploadedFiles = [];
        // Voucher state for Request total
        let appliedVoucher = null; // 'student' | null
        const VOUCHER_RATE = 0.10;
        let lastBaseServicesTotal = null; // number|null

        // Google Identity (email verification) state
        let googleEmailVerified = false;
        let googleVerifiedEmail = '';
        let googleIdToken = null; // store only, not sent for verification
        let googleUserId = null; // JWT 'sub'
        let googleIdEmail = ''; // decoded email prior to verification

        // Debug flag (?debug=1 in URL enables console tracing)
        const DEBUG = /[?&]debug=1\b/.test(location.search);
        if (DEBUG) console.info('[DEBUG] Mode ON');

        // Cost tables loader (from CSV assets)
        const costTables = { basic: {}, semedx: {} };

        function parseCsvToTable(csvText) {
            const table = {};
            if (!csvText) return table;
            const rows = csvText.trim().split(/\r?\n/);
            for (let i = 0; i < rows.length; i++) {
                const cols = rows[i].split(',');
                if (!cols.length) continue;
                const count = parseInt((cols[0] || '').trim(), 10);
                const costRaw = (cols[7] || '').trim();
                const cost = parseFloat(costRaw.replace(/[^0-9.]/g, ''));
                if (!isNaN(count) && !isNaN(cost)) {
                    table[count] = cost;
                }
            }
            return table;
        }

        async function loadCostTables() {
            try {
                const [semResp, semedxResp] = await Promise.all([
                    fetch('assets/SEM.csv'),
                    fetch('assets/SEMEDX.csv')
                ]);
                if (semResp.ok) {
                    const semText = await semResp.text();
                    costTables.basic = parseCsvToTable(semText);
                }
                if (semedxResp.ok) {
                    const semedxText = await semedxResp.text();
                    costTables.semedx = parseCsvToTable(semedxText);
                }
            } catch (err) {
                console.error('Failed to load cost tables:', err);
            }
        }

        // Cost Calculator
        function updateCost() {
            const samples = parseInt(document.getElementById('samples').value) || 1;
            const analysisType = document.getElementById('analysis-type').value || 'basic';
            let total = null;
            const table = costTables[analysisType] || {};
            if (table && typeof table[samples] !== 'undefined') {
                total = table[samples];
            }
            const totalEl = document.getElementById('total-cost');
            if (total !== null) {
                totalEl.textContent = Number(total).toLocaleString();
            } else {
                totalEl.textContent = '—';
            }
        }

        // Requested Services total (inside Request form)
        function updateServicesCost() {
            const samplesInputEl = document.getElementById('sample-count');
            const samples = parseInt(samplesInputEl && samplesInputEl.value, 10) || 1;
            const selectedChar = document.querySelector('input[name="characterization"]:checked');
            const key = selectedChar && selectedChar.value === 'sem-and-edx' ? 'semedx' : 'basic';
            const table = costTables[key] || {};
            const baseTotal = typeof table[samples] !== 'undefined' ? Number(table[samples]) : null;
            lastBaseServicesTotal = baseTotal;

            const el = document.getElementById('services-total-cost');
            const summary = document.getElementById('services-summary');
            const subEl = document.getElementById('services-subtotal');
            const discEl = document.getElementById('services-discount');
            const finalEl = document.getElementById('services-total-final');

            // Default: hide summary until a valid voucher is applied and base total exists
            if (summary) summary.hidden = true;

            if (baseTotal === null) {
                if (el) el.textContent = '—';
                return;
            }

            // Apply voucher if present
            let discountAmount = 0;
            let finalTotal = baseTotal;
            if (appliedVoucher === 'student') {
                discountAmount = baseTotal * VOUCHER_RATE;
                finalTotal = baseTotal - discountAmount;
                if (summary && subEl && discEl && finalEl) {
                    subEl.textContent = Number(baseTotal).toLocaleString();
                    discEl.textContent = '-' + Number(discountAmount).toLocaleString();
                    finalEl.textContent = Number(finalTotal).toLocaleString();
                    summary.hidden = false;
                }
            }

            if (el) el.textContent = Number(finalTotal).toLocaleString();
        }

        // Add event listeners for calculator
        document.getElementById('samples').addEventListener('input', updateCost);
        document.getElementById('analysis-type').addEventListener('change', updateCost);
        // Link Requested Services inputs to services total
        const sampleCountEl = document.getElementById('sample-count');
        if (sampleCountEl) sampleCountEl.addEventListener('input', updateServicesCost);
        document.querySelectorAll('input[name="characterization"]').forEach(r => {
            r.addEventListener('change', updateServicesCost);
        });
        // Removed extra spots and rush service fields

        // Sync samples slider with number input and vice versa
        const samplesInput = document.getElementById('samples');
        const samplesSlider = document.getElementById('samples-slider');
        if (samplesSlider && samplesInput) {
            // Initialize slider to current input value
            samplesSlider.value = samplesInput.value || 1;
            // Slider -> Input
            samplesSlider.addEventListener('input', function() {
                samplesInput.value = this.value;
                updateCost();
            });
            // Input -> Slider (without triggering extra updateCost)
            samplesInput.addEventListener('input', function() {
                samplesSlider.value = this.value || 1;
            });
        }

        // Utility: find uploaded file index by fileId
        function findUploadedIndex(fileId){
            return uploadedFiles.findIndex(f => f.fileId === fileId);
        }

        // Render uploaded files list
        function renderUploadedFiles(){
            const fileList = document.getElementById('file-list');
            if (!fileList) return;
            fileList.innerHTML = '';
            if (!uploadedFiles.length){
                const empty = document.createElement('div');
                empty.style.marginTop = '0.75rem';
                empty.style.fontSize = '0.85rem';
                empty.style.color = '#6c757d';
                empty.textContent = 'No files uploaded yet.';
                fileList.appendChild(empty);
                return;
            }
            uploadedFiles.forEach(f => {
                const row = document.createElement('div');
                row.style.display = 'flex';
                row.style.alignItems = 'center';
                row.style.justifyContent = 'space-between';
                row.style.background = '#f8f9fa';
                row.style.padding = '0.5rem 0.75rem';
                row.style.borderRadius = '4px';
                row.style.marginBottom = '0.5rem';
                row.style.fontSize = '0.85rem';
                row.setAttribute('data-file-id', f.fileId);
                const info = document.createElement('span');
                info.textContent = `📎 ${f.name} (${(f.size/1024/1024).toFixed(2)} MB)`;
                const actions = document.createElement('div');
                actions.style.display = 'flex';
                actions.style.alignItems = 'center';
                actions.style.gap = '0.5rem';
                const delBtn = document.createElement('button');
                delBtn.type = 'button';
                delBtn.textContent = '×';
                delBtn.setAttribute('aria-label', `Remove ${f.name}`);
                delBtn.style.cursor = 'pointer';
                delBtn.style.background = '#dc3545';
                delBtn.style.color = '#fff';
                delBtn.style.border = 'none';
                delBtn.style.width = '24px';
                delBtn.style.height = '24px';
                delBtn.style.borderRadius = '4px';
                delBtn.style.fontSize = '16px';
                delBtn.style.lineHeight = '20px';
                delBtn.style.display = 'flex';
                delBtn.style.alignItems = 'center';
                delBtn.style.justifyContent = 'center';
                delBtn.addEventListener('click', () => deleteUploadedFile(f.fileId, f.name));
                actions.appendChild(delBtn);
                row.appendChild(info);
                row.appendChild(actions);
                fileList.appendChild(row);
            });
        }

        function deleteUploadedFile(fileId, name){
            if (!fileId) return;
            const url = `${GAS_UPLOAD_URL}?key=${encodeURIComponent(API_KEY)}&fileId=${encodeURIComponent(fileId)}`;
            // Immediate persistent notice while updating the list
            const preMsg = renderUploadMessage(`🗑️ Deleting ${name} — updating list…`, 'info', 0);
            fetch(url)
                .then(r => r.json().catch(()=>({raw:r.status})))
                .then(resp => {
                    const idx = findUploadedIndex(fileId);
                    if (idx !== -1){
                        uploadedFiles.splice(idx,1);
                        renderUploadedFiles();
                        // Wait until the row is gone from the DOM before finalizing message
                        const list = document.getElementById('file-list');
                        const sel = `[data-file-id="${fileId}"]`;
                        let tries = 0;
                        (function waitRemoval(){
                            const exists = !!(list && list.querySelector(sel));
                            if (!exists) {
                                if (preMsg && preMsg.parentNode) preMsg.parentNode.removeChild(preMsg);
                                renderUploadMessage(`✅ Deleted ${name}`, 'success');
                            } else if (tries++ < 10) {
                                requestAnimationFrame(waitRemoval);
                            } else {
                                // Fallback: clear the pre-message and show success anyway
                                if (preMsg && preMsg.parentNode) preMsg.parentNode.removeChild(preMsg);
                                renderUploadMessage(`✅ Deleted ${name}`, 'success');
                            }
                        })();
                    } else {
                        if (preMsg && preMsg.parentNode) preMsg.parentNode.removeChild(preMsg);
                        renderUploadMessage(`⚠️ File not found locally after delete: ${name}`, 'info');
                    }
                })
                .catch(err => {
                    if (preMsg && preMsg.parentNode) preMsg.parentNode.removeChild(preMsg);
                    renderUploadMessage(`❌ Delete failed for ${name}: ${err.message || err}`, 'error');
                });
        }

        // Convert File to base64 data URL
        function fileToDataUrl(file){
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = () => reject(reader.error || new Error('File read error'));
                reader.readAsDataURL(file);
            });
        }

        async function uploadSingleFile(file){
            // Dedupe by name+size
            if (uploadedFiles.some(f => f.name === file.name && f.size === file.size)){
                renderUploadMessage(`Skipping duplicate: ${file.name}`, 'info');
                return;
            }
            const errors = validateFiles([file], 10);
            if (errors.length){
                renderUploadMessage('❌ File validation failed:<br>' + errors.map(e => `• ${e}`).join('<br>'), 'error');
                return;
            }
            renderUploadMessage(`Uploading ${file.name}…`, 'info');
            let dataUrl;
            try {
                dataUrl = await fileToDataUrl(file);
            } catch (err){
                renderUploadMessage(`❌ Read failed: ${file.name} - ${err.message || err}`, 'error');
                return;
            }
            const body = new URLSearchParams({
                key: API_KEY,
                data: dataUrl,
                mimetype: file.type || 'application/octet-stream',
                filename: file.name
            });
            try {
                const resp = await fetch(GAS_UPLOAD_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body
                });
                const text = await resp.text();
                let json; try { json = JSON.parse(text); } catch(_) {}
                // Strictly require Drive fileId from JSON; do not fall back to filename/text
                const fileId = json && json.fileId ? json.fileId : null;
                const serverFilename = json && json.filename ? json.filename : file.name;
                if (!fileId) {
                    renderUploadMessage(`❌ Upload response missing fileId (expected JSON { fileId }) for ${file.name}`, 'error');
                    return;
                }
                // Show immediate acknowledgment while preparing the list entry
                const preMsg = renderUploadMessage(`✅ Uploaded ${file.name} — adding to list…`, 'success', 0);
                // Store only the Drive fileId; keep original name for display
                uploadedFiles.push({ fileId, name: file.name, size: file.size, type: file.type, serverFilename });
                renderUploadedFiles();
                // After the row renders, replace the pre-message with the final success
                const list = document.getElementById('file-list');
                const sel = `[data-file-id="${fileId}"]`;
                let tries = 0;
                (function checkInserted(){
                    if (list && list.querySelector(sel)) {
                        if (preMsg && preMsg.parentNode) preMsg.parentNode.removeChild(preMsg);
                        renderUploadMessage(`✅ Uploaded ${file.name}`, 'success');
                    } else if (tries++ < 10) {
                        requestAnimationFrame(checkInserted);
                    } else {
                        // Fallback: clear the pre-message to avoid lingering, then show final success
                        if (preMsg && preMsg.parentNode) preMsg.parentNode.removeChild(preMsg);
                        renderUploadMessage(`✅ Uploaded ${file.name}`, 'success');
                    }
                })();
            } catch (err){
                renderUploadMessage(`❌ Upload failed: ${file.name} - ${err.message || err}`, 'error');
            }
        }

        // Auto-upload handler on selection
        document.getElementById('file-input').addEventListener('change', async function(e){
            const files = Array.from(e.target.files || []);
            if (!files.length) return;
            for (const f of files){
                // Sequential upload to reduce load
                await uploadSingleFile(f);
            }
            // Clear native file input so re-selecting same file triggers change event again
            e.target.value = '';
        });
        // Initial render
        renderUploadedFiles();

        // Helpers: gather form meta for backend (serialize essential fields)
        function collectFormMeta() {
            const form = document.getElementById('service-form');
            const getVal = id => (document.getElementById(id)?.value || '').trim();
            const getRadio = name => {
                const el = document.querySelector(`input[name="${name}"]:checked`);
                return el ? el.value : '';
            };
            const getExpectations = () => Array.from(document.querySelectorAll('input[name="expectations"]:checked')).map(c => c.value);
            // Sanitization helper (lightweight: strip angle brackets, collapse whitespace, limit length)
            const sanitizeText = (str, maxLen = 1000) => {
                if (typeof str !== 'string') return '';
                return str.replace(/[<>]/g, '').replace(/\s+/g, ' ').trim().slice(0, maxLen);
            };
            // Apply sanitization to free-text inputs
            const fullName = sanitizeText(getVal('full-name'), 120);
            const emailVal = sanitizeText(getVal('email'), 254);
            const mobileNumber = sanitizeText(getVal('mobile-number'), 32);
            const positionVal = (document.getElementById('position')?.value || '');
            const otherPosition = sanitizeText(getVal('other-position'), 120);
            const schoolName = sanitizeText(getVal('school-name'), 180);
            const schoolAddress = sanitizeText(getVal('school-address'), 400);
            const characterization = getRadio('characterization');
            const sampleCount = sanitizeText(getVal('sample-count'), 6);
            const conductive = getRadio('conductive');
            const deliveryDate = sanitizeText(getVal('delivery-date'), 32);
            const turnaround = sanitizeText(getVal('turnaround'), 32);
            const researchObjectives = sanitizeText(getVal('research-objectives'), 1500);
            const sampleCharacteristics = sanitizeText(getVal('sample-characteristics'), 800);
            const expectationsRaw = getExpectations();
            const otherExpectation = sanitizeText(getVal('other-expectation'), 200);
            const edxElements = sanitizeText(getVal('edx-elements'), 600);
            return {
                fullName,
                email: emailVal,
                mobileNumber,
                position: positionVal,
                otherPosition,
                schoolName,
                schoolAddress,
                characterization,
                sampleCount,
                conductive,
                deliveryDate,
                turnaround,
                researchObjectives,
                sampleCharacteristics,
                expectations: expectationsRaw,
                otherExpectation,
                edxElements,
                submittedAt: new Date().toISOString(),
                pageOrigin: location.href,
                uploadedFileIds: uploadedFiles.map(f => f.fileId),
                // Google email verification snapshot
                googleEmailVerified: !!googleEmailVerified,
                googleVerifiedEmail: googleVerifiedEmail,
                googleIdToken: googleIdToken,
                googleUserId: googleUserId,
                googleIdEmail: googleIdEmail,
                // Voucher + totals snapshot
                voucherCode: appliedVoucher || '',
                discountRate: appliedVoucher === 'student' ? VOUCHER_RATE : 0,
                baseServicesTotal: lastBaseServicesTotal,
                discountAmount: appliedVoucher === 'student' && lastBaseServicesTotal != null ? (lastBaseServicesTotal * VOUCHER_RATE) : 0,
                finalServicesTotal: lastBaseServicesTotal != null ? (lastBaseServicesTotal - (appliedVoucher === 'student' ? lastBaseServicesTotal * VOUCHER_RATE : 0)) : null
            };
        }

        // Build a flat payload (sheet headers) for Apps Script addRow (urlencoded)
        function buildFormPayload(meta){
            // Position resolution
            const positionResolved = meta.position === 'other' && meta.otherPosition ? meta.otherPosition : meta.position;
            // Characterization label expected by the sheet
            const kindLabel = meta.characterization === 'sem-and-edx' ? 'SEM and EDX' : 'SEM only';
            // Expectations processing (replace 'other' token with value)
            const expectations = (meta.expectations || []).map(v => v === 'other' ? (meta.otherExpectation || 'Other (unspecified)') : v);
            // Attachments: clickable Drive links
            const attachmentLinks = (meta.uploadedFileIds || []).map(id => `https://drive.google.com/file/d/${id}/view`);
            // Conductive mapping to Yes/No
            const conductiveLabel = meta.conductive === 'yes' ? 'Yes' : (meta.conductive === 'no' ? 'No' : '');
            // Local timestamp: YYYY-MM-DD HH:mm
            const d = new Date();
            const pad = n => String(n).padStart(2,'0');
            const tsLocal = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;

            // Numeric fields to plain strings (or empty if null)
            const toNumStr = v => (v === null || typeof v === 'undefined' || v === '') ? '' : String(v);

            return {
                // Router function + API key
                func: 'addRow',
                key: FORM_API_KEY,

                // Exact sheet header keys
                Timestamp: tsLocal,
                GoogleID: meta.googleUserId || '',
                GoogleEmail: meta.googleVerifiedEmail || '',
                'Full Name': meta.fullName,
                Email: meta.email,
                Mobile: meta.mobileNumber,
                Position: positionResolved,
                School: meta.schoolName,
                Address: meta.schoolAddress,
                KindCharacterization: kindLabel,
                Samples: meta.sampleCount,
                Conductive: conductiveLabel,
                DeliveryDate: meta.deliveryDate,
                TurnaroundDate: meta.turnaround,
                SubTotalCost: toNumStr(meta.baseServicesTotal),
                VoucherCode: meta.voucherCode || '',
                Discount: toNumStr(meta.discountAmount),
                TotalCost: toNumStr(meta.finalServicesTotal),
                AnalysisObjectives: meta.researchObjectives,
                SampleCharacteristics: meta.sampleCharacteristics,
                SEMExpectations: expectations.join(', '),
                EDXElements: meta.edxElements,
                Attachments: attachmentLinks.join(', ')
            };
        }

        async function submitFormToGAS(payload){
            if (!GAS_FORM_URL) throw new Error('Form endpoint not configured');
            // Convert flat object to urlencoded for Apps Script
            const params = new URLSearchParams();
            Object.keys(payload || {}).forEach(k => {
                const v = payload[k];
                params.set(k, v == null ? '' : String(v));
            });
            const resp = await fetch(GAS_FORM_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: params
            });
            const text = await resp.text();
            let json; try { json = JSON.parse(text); } catch(_) {}
            return json || { raw: text, status: resp.status };
        }

        function bytesToMB(n){ return (n/1024/1024).toFixed(2); }

        function validateFiles(files, maxMB = 10) {
            const allowedExts = ['jpg','jpeg','png','gif','webp','pdf','doc','docx'];
            const errors = [];
            Array.from(files).forEach(f => {
                const ext = (f.name.split('.').pop() || '').toLowerCase();
                if (!allowedExts.includes(ext)) {
                    errors.push(`Unsupported file type: ${f.name}`);
                }
                const maxBytes = maxMB * 1024 * 1024;
                if (f.size > maxBytes) {
                    errors.push(`File too large (> ${maxMB} MB): ${f.name} (${bytesToMB(f.size)} MB)`);
                }
            });
            return errors;
        }

        function renderMessage(html, kind = 'info') {
            const box = document.getElementById('form-messages');
            if (!box) return;
            const colors = {
                error: { bg: '#f8d7da', fg: '#721c24', border: '#f5c6cb' },
                success: { bg: '#d4edda', fg: '#155724', border: '#c3e6cb' },
                info: { bg: '#e2e3e5', fg: '#383d41', border: '#d6d8db' }
            };
            const c = colors[kind] || colors.info;
            const div = document.createElement('div');
            div.style.background = c.bg;
            div.style.color = c.fg;
            div.style.padding = '1rem';
            div.style.borderRadius = '5px';
            div.style.marginTop = '1rem';
            div.style.border = `1px solid ${c.border}`;
            div.innerHTML = html;
            box.appendChild(div);
            return div;
        }

        // Auto-dismiss toast (short, non-intrusive message)
        function showToast(message, kind = 'error', ttlMs = 2600) {
            if (!message) return;
            let container = document.getElementById('toast-container');
            if (!container) {
                container = document.createElement('div');
                container.id = 'toast-container';
                container.className = 'toast-container';
                document.body.appendChild(container);
            }
            const t = document.createElement('div');
            t.className = 'toast ' + (kind || 'info');
            t.setAttribute('role', 'status');
            t.setAttribute('aria-live', 'polite');
            t.textContent = message;
            container.appendChild(t);
            // Animate in
            requestAnimationFrame(() => t.classList.add('show'));
            // Auto remove
            const remove = () => {
                t.classList.remove('show');
                setTimeout(() => { if (t.parentNode === container) container.removeChild(t); }, 180);
            };
            const id = setTimeout(remove, Math.max(1200, ttlMs|0));
            // Allow manual dismissal on click
            t.addEventListener('click', () => { clearTimeout(id); remove(); });
            return t;
        }

        // Upload-specific transient messages below the upload control
        function renderUploadMessage(html, kind = 'info', ttlMs = 2000) {
            const box = document.getElementById('upload-messages');
            if (!box) return;
            const colors = {
                error: { bg: '#f8d7da', fg: '#721c24', border: '#f5c6cb' },
                success: { bg: '#d4edda', fg: '#155724', border: '#c3e6cb' },
                info: { bg: '#e2e3e5', fg: '#383d41', border: '#d6d8db' }
            };
            const c = colors[kind] || colors.info;
            const div = document.createElement('div');
            div.style.background = c.bg;
            div.style.color = c.fg;
            div.style.padding = '0.6rem 0.8rem';
            div.style.borderRadius = '5px';
            div.style.marginTop = '0.5rem';
            div.style.border = `1px solid ${c.border}`;
            div.style.fontSize = '0.9rem';
            div.innerHTML = html;
            box.appendChild(div);
            if (ttlMs > 0) {
                setTimeout(() => {
                    if (div.parentNode === box) box.removeChild(div);
                }, ttlMs);
            }
            return div;
        }

        function clearMessages() {
            const box = document.getElementById('form-messages');
            if (box) box.innerHTML = '';
        }

        // Clear the entire form and local state (including attachments)
        function clearFormAndState(opts = {}) {
            const { clearMessagesBox = true } = opts || {};

            // Clear messages (optional)
            if (clearMessagesBox) clearMessages();
            // Clear inline errors
            document.querySelectorAll('.error').forEach(el => el.classList.remove('error'));
            document.querySelectorAll('.inline-error').forEach(el => el.remove());

            // Reset form fields
            const form = document.getElementById('service-form');
            if (form) form.reset();

            // Clear uploaded files and UI
            uploadedFiles.length = 0;
            renderUploadedFiles();
            const fileInput = document.getElementById('file-input');
            if (fileInput) fileInput.value = '';

            // Reset voucher and totals
            appliedVoucher = null;
            lastBaseServicesTotal = null;
            const vi = document.getElementById('voucher-input');
            if (vi) vi.value = '';
            const vs = document.getElementById('voucher-status');
            if (vs) { vs.textContent = ''; vs.classList.remove('success','error'); }
            const summary = document.getElementById('services-summary');
            if (summary) summary.hidden = true;
            updateServicesCost();

            // Reset Google verification state and UI
            googleEmailVerified = false;
            googleVerifiedEmail = '';
            googleIdToken = null;
            googleUserId = null;
            const emailField = document.getElementById('email');
            if (emailField) { emailField.readOnly = true; emailField.value = ''; emailField.classList.remove('error'); }
            const gbtn = document.getElementById('google-login-btn');
            if (gbtn) gbtn.style.display = '';
            const gst = document.getElementById('google-login-status');
            if (gst) { gst.textContent = 'Use Google Sign-In to verify your email.'; gst.classList.remove('status-success','status-error'); }
        }

        // (Deprecated) Old batch upload function retained for reference but unused now.
        // function submitServiceRequestGAS(meta, files, onProgress) { /* deprecated */ }

        // Metadata-only submission (no file blobs; assumes files already uploaded)
        async function submitServiceMeta(meta){
            if (!GAS_UPLOAD_URL) throw new Error('Endpoint not configured');
            const body = new URLSearchParams({
                key: API_KEY,
                meta: JSON.stringify(meta),
                fileIds: JSON.stringify(meta.uploadedFileIds || [])
            });
            const resp = await fetch(GAS_UPLOAD_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body
            });
            const text = await resp.text();
            let json; try { json = JSON.parse(text); } catch(_) {}
            return json || text;
        }

        // Form validation and submission
        document.getElementById('service-form').addEventListener('submit', function(e) {
            e.preventDefault();

            // Clear previous messages and error states
            clearMessages();
            document.querySelectorAll('.error').forEach(el => el.classList.remove('error'));
            document.querySelectorAll('.inline-error').forEach(el => el.remove());

            const showFieldError = (el, msg) => {
                if (!el) return;
                const group = el.closest && el.closest('.form-group') ? el.closest('.form-group') : el.parentElement;
                if (group) {
                    const existing = group.querySelector('.inline-error');
                    if (existing) existing.remove();
                    const hint = document.createElement('div');
                    hint.className = 'error-message inline-error';
                    hint.textContent = msg;
                    group.appendChild(hint);
                }
            };

            const focusAndMessage = (el, msg) => {
                if (el) {
                    el.classList.add('error');
                    try { el.scrollIntoView({ behavior: 'smooth', block: 'center' }); } catch(_) {}
                    try { el.focus({ preventScroll: true }); } catch(_) {}
                }
                showFieldError(el, msg);
                // Brief, auto-dismissing toast for quick guidance
                showToast(msg, 'error', 2800);
            };

            // A. Requestee Information (top to bottom)
            const fullNameEl = document.getElementById('full-name');
            if (!fullNameEl.value.trim()) { if (DEBUG) console.warn('[DEBUG] full-name empty'); return focusAndMessage(fullNameEl, 'Please enter your Full Name.'); }

            const emailEl = document.getElementById('email');
            if (!googleEmailVerified) {
                if (DEBUG) console.warn('[DEBUG] email not verified', { googleEmailVerified, googleVerifiedEmail });
                if (emailEl) emailEl.classList.add('error');
                const st = document.getElementById('google-login-status');
                if (st) { st.textContent = 'Please verify your email with Google Sign-In.'; st.classList.remove('status-success'); st.classList.add('status-error'); }
                showFieldError(emailEl, 'Please verify your Email Address via Google Sign-In.');
                return focusAndMessage(emailEl, 'Please verify your Email Address via Google Sign-In.');
            } else if (!emailEl.value.trim()) {
                // Should not happen, but ensure the field is populated with verified email
                if (googleVerifiedEmail) emailEl.value = googleVerifiedEmail;
            }

            const mobileEl = document.getElementById('mobile-number');
            const phoneVal = (mobileEl.value || '').trim();
            if (!phoneVal) { if (DEBUG) console.warn('[DEBUG] mobile-number empty'); return focusAndMessage(mobileEl, 'Please enter your Mobile Number.'); }
            const phoneOk = /^[+0-9()\- ]{7,20}$/.test(phoneVal);
            if (!phoneOk) { if (DEBUG) console.warn('[DEBUG] mobile-number pattern mismatch', phoneVal); return focusAndMessage(mobileEl, 'Mobile Number can contain digits, spaces, (), -, + (7–20 chars).'); }

            const positionEl = document.getElementById('position');
            if (!positionEl.value) { if (DEBUG) console.warn('[DEBUG] position empty'); return focusAndMessage(positionEl, 'Please select your Position/Designation.'); }
            if (positionEl.value === 'other') {
                const otherPosEl = document.getElementById('other-position');
                if (!otherPosEl.value.trim()) { if (DEBUG) console.warn('[DEBUG] other-position empty'); return focusAndMessage(otherPosEl, 'Please specify your Position/Designation.'); }
            }

            const schoolNameEl = document.getElementById('school-name');
            if (!schoolNameEl.value.trim()) { if (DEBUG) console.warn('[DEBUG] school-name empty'); return focusAndMessage(schoolNameEl, 'Please enter the Name of School / Company / Organization.'); }

            const schoolAddrEl = document.getElementById('school-address');
            if (!schoolAddrEl.value.trim()) { if (DEBUG) console.warn('[DEBUG] school-address empty'); return focusAndMessage(schoolAddrEl, 'Please enter the Address of School / Company / Organization.'); }

            // B. Requested Services
            const characterizationEl = document.querySelector('input[name="characterization"]:checked');
            if (!characterizationEl) { if (DEBUG) console.warn('[DEBUG] characterization missing'); return focusAndMessage(document.querySelector('input[name="characterization"]'), 'Please choose the Kind of Characterization.'); }

            const sampleCountEl2 = document.getElementById('sample-count');
            const sampleCountVal = parseInt(sampleCountEl2.value, 10);
            if (!sampleCountVal || sampleCountVal < 1) { if (DEBUG) console.warn('[DEBUG] sample-count invalid', sampleCountVal); return focusAndMessage(sampleCountEl2, 'Please enter a valid Number of Samples.'); }

            const conductiveEl = document.querySelector('input[name="conductive"]:checked');
            if (!conductiveEl) { if (DEBUG) console.warn('[DEBUG] conductive missing'); return focusAndMessage(document.querySelector('input[name="conductive"]'), 'Please indicate if your samples are conductive.'); }

            const deliveryEl = document.getElementById('delivery-date');
            if (!deliveryEl.value) { if (DEBUG) console.warn('[DEBUG] delivery-date empty'); return focusAndMessage(deliveryEl, 'Please select the Date to Deliver the Samples.'); }

            const turnaroundEl = document.getElementById('turnaround');
            if (!turnaroundEl.value) { if (DEBUG) console.warn('[DEBUG] turnaround empty'); return focusAndMessage(turnaroundEl, 'Please select the turnaround time for results.'); }

            // C. Sample Characteristics & Research Requirements
            const objectivesEl = document.getElementById('research-objectives');
            if (!objectivesEl.value.trim()) { if (DEBUG) console.warn('[DEBUG] research-objectives empty'); return focusAndMessage(objectivesEl, 'Please provide your Analysis Objectives.'); }

            const sampleCharEl = document.getElementById('sample-characteristics');
            if (!sampleCharEl.value.trim()) { if (DEBUG) console.warn('[DEBUG] sample-characteristics empty'); return focusAndMessage(sampleCharEl, 'Please describe your sample characteristics.'); }

            const chosenExpectations = document.querySelectorAll('input[name="expectations"]:checked');
            if (!chosenExpectations.length) { if (DEBUG) console.warn('[DEBUG] expectations none selected'); return focusAndMessage(document.querySelector('input[name="expectations"]'), 'Please select at least one SEM Micrograph Expectation.'); }

            const otherExpChecked = document.querySelector('input[name="expectations"][value="other"]:checked');
            if (otherExpChecked) {
                const otherExpEl = document.getElementById('other-expectation');
                if (!otherExpEl.value.trim()) { if (DEBUG) console.warn('[DEBUG] other-expectation empty'); return focusAndMessage(otherExpEl, 'Please specify your "Other" SEM expectation.'); }
            }

            // EDX elements are required only if SEM and EDX is selected
            const charVal = characterizationEl ? characterizationEl.value : '';
            if (charVal === 'sem-and-edx') {
                const edxEl = document.getElementById('edx-elements');
                if (!edxEl.value.trim()) { if (DEBUG) console.warn('[DEBUG] edx-elements empty while sem-and-edx selected'); return focusAndMessage(edxEl, 'Please specify EDX Target Elements for SEM and EDX.'); }
            }

            // Files uploaded
            if (uploadedFiles.length === 0) {
                const uploadBox = document.getElementById('file-input');
                if (DEBUG) console.warn('[DEBUG] no files uploaded');
                return focusAndMessage(uploadBox, 'Please upload at least one reference file.');
            }

            // Begin metadata submission (files already uploaded individually)
            const submitButton = document.querySelector('.submit-button');
            const originalText = submitButton.textContent;
            submitButton.textContent = 'Submitting...';
            submitButton.disabled = true;
            const statusBox = renderMessage('Submitting request…', 'info');

            const meta = collectFormMeta();
            // Build payload & submit to GAS (urlencoded addRow)
            const formPayload = buildFormPayload(meta);
            submitFormToGAS(formPayload).then(resp => {
                if (statusBox) statusBox.remove();
                renderMessage('✅ <strong>Request submitted successfully!</strong><br>Please reply to our email to confirm your service request. Thank you', 'success');
                // Small success toast to inform about email confirmation
                showToast('✅ Request submitted! Please check your email for confirmation.', 'success', 3400);
                // Clear form and state but keep success message visible
                clearFormAndState({ clearMessagesBox: false });
                submitButton.textContent = originalText;
                submitButton.disabled = false;
                const box = document.getElementById('form-messages');
                if (box) box.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }).catch(err => {
                if (statusBox) statusBox.remove();
                renderMessage(`❌ Submission failed: ${err.message || err}`, 'error');
                submitButton.textContent = originalText;
                submitButton.disabled = false;
            });
        });

        

        // Page navigation functionality
        function showPage(pageId) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // Show selected page
            const targetPage = document.getElementById(pageId + '-page');
            if (targetPage) {
                targetPage.classList.add('active');
            }
            
            // Update active navigation button
            document.querySelectorAll('.nav-button').forEach(button => {
                button.classList.remove('active');
            });
            
            const activeButton = document.querySelector(`[data-section="${pageId}"]`);
            if (activeButton) {
                activeButton.classList.add('active');
            }

            // If navigating to Request page, ensure promo banner is visible if eligible
            if (pageId === 'request') {
                if (typeof ensurePromoBannerVisibleIfEligible === 'function') {
                    ensurePromoBannerVisibleIfEligible();
                }
            }
            
            // Scroll to top of main content
            window.scrollTo({ top: 0, behavior: 'smooth' });

            // Toggle footer visibility (only show on About page)
            const siteFooter = document.querySelector('footer.footer');
            if (siteFooter) {
                if (pageId === 'about') {
                    siteFooter.style.display = 'block';
                } else {
                    siteFooter.style.display = 'none';
                }
            }
        }

        // Navigation button click handlers
        document.querySelectorAll('.nav-button').forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                const pageId = this.dataset.section;
                showPage(pageId);
            });
        });

        // CTA button handler (specific to a dedicated Request CTA only)
        // Use a specific ID to avoid hijacking other links styled with .cta-button (e.g., download links)
        const ctaButton = document.getElementById('cta-request');
        if (ctaButton) {
            ctaButton.addEventListener('click', function(e) {
                e.preventDefault();
                showPage('request');
            });
        }

        // Initialize with about page active
        window.addEventListener('load', function() {
            showPage('about');
        });
        
        // Google Identity: initialize Sign-In button when the library is ready
        function parseJwt(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                return JSON.parse(jsonPayload);
            } catch (_) { return {}; }
        }

        function handleGoogleCredential(response) {
            try {
                const token = response && response.credential;
                const payload = parseJwt(token || '');
                const email = payload.email || '';
                const sub = payload.sub || null;
                googleUserId = sub;
                googleIdToken = token;
                googleIdEmail = email;
                // Update UI to reflect pending verification
                const st = document.getElementById('google-login-status');
                if (st) { st.textContent = email ? ('Verifying token for ' + email + '…') : 'No email in credential.'; st.classList.remove('status-success'); st.classList.add('status-error'); }
                const emailEl = document.getElementById('email');
                if (emailEl && email) {
                    emailEl.value = email; emailEl.readOnly = true; emailEl.classList.remove('error');
                    const ih = emailEl.closest && emailEl.closest('.form-group')?.querySelector('.inline-error');
                    if (ih) ih.remove();
                }
                if (!token || !email || !sub) {
                    if (st) { st.textContent = 'Credential incomplete. Please retry Google Sign-In.'; }
                    return;
                }
                // Perform remote verification against Google tokeninfo
                fetch('https://oauth2.googleapis.com/tokeninfo?id_token=' + encodeURIComponent(token))
                    .then(r => r.ok ? r.json() : Promise.reject(new Error('tokeninfo HTTP ' + r.status)))
                    .then(data => {
                        const tkEmail = data.email || '';
                        const tkSub = data.sub || '';
                        if (tkEmail === email && tkSub === sub) {
                            googleEmailVerified = true;
                            googleVerifiedEmail = email;
                            if (st) { st.textContent = 'Verified as ' + email; st.classList.remove('status-error'); st.classList.add('status-success'); }
                            const btn = document.getElementById('google-login-btn');
                            if (btn) btn.style.display = 'none';
                        } else {
                            if (st) { st.textContent = 'Token mismatch. Please re-authenticate.'; st.classList.remove('status-success'); st.classList.add('status-error'); }
                            googleEmailVerified = false;
                        }
                    })
                    .catch(err => {
                        if (st) { st.textContent = 'Token verification failed: ' + (err.message || err); st.classList.remove('status-success'); st.classList.add('status-error'); }
                        googleEmailVerified = false;
                    });
            } catch (err) {
                const st = document.getElementById('google-login-status');
                if (st) { st.textContent = 'Verification error. Please try again.'; st.classList.remove('status-success'); st.classList.add('status-error'); }
            }
        }

        function initGoogleSignIn() {
            if (!window.google || !google.accounts || !google.accounts.id) return;
            google.accounts.id.initialize({
                client_id: '454869523412-572v5b7uqvebd7ohmgvck014ah68e3d6.apps.googleusercontent.com',
                callback: handleGoogleCredential,
                auto_select: false,
                use_fedcm_for_prompt: false
            });
            const btnEl = document.getElementById('google-login-btn');
            if (btnEl) {
                google.accounts.id.renderButton(btnEl, {
                    theme: 'outline',
                    size: 'large',
                    type: 'standard',
                    text: 'signin_with'
                });
            }
        }

        function setupGoogleButtonWhenReady(tries = 0) {
            if (window.google && google.accounts && google.accounts.id) {
                initGoogleSignIn();
            } else if (tries < 20) {
                setTimeout(() => setupGoogleButtonWhenReady(tries + 1), 250);
            } else {
                console.warn('Google Identity Services library not available.');
            }
        }
        
        window.addEventListener('load', setupGoogleButtonWhenReady);

        // Live validation helpers and bindings
        function clearInlineError(el) {
            if (!el) return;
            el.classList.remove('error');
            const group = el.closest && el.closest('.form-group');
            if (group) {
                const ih = group.querySelector('.inline-error');
                if (ih) ih.remove();
            }
        }

        function clearGroupErrorFor(selector) {
            const first = document.querySelector(selector);
            if (!first) return;
            const group = first.closest && first.closest('.form-group');
            if (group) {
                group.querySelectorAll('.inline-error').forEach(n => n.remove());
                group.querySelectorAll('.error').forEach(n => n.classList.remove('error'));
            }
        }

        function initLiveValidation() {
            const bind = (sel, ev = 'input', fn) => {
                const el = document.getElementById(sel) || document.querySelector(sel);
                if (el) el.addEventListener(ev, fn);
            };

            // Text inputs and textareas
            ['full-name','mobile-number','school-name','school-address','research-objectives','sample-characteristics','other-position','other-expectation','edx-elements','sample-count'].forEach(id => {
                bind(id, 'input', function(){ clearInlineError(this); });
            });
            // Selects and date
            bind('delivery-date', 'change', function(){ clearInlineError(this); });
            bind('turnaround', 'change', function(){ clearInlineError(this); });
            bind('position', 'change', function(){ clearInlineError(this); });

            // Radio groups
            document.querySelectorAll('input[name="characterization"]').forEach(r => {
                r.addEventListener('change', function(){
                    clearGroupErrorFor('input[name="characterization"]');
                    // If switching away from SEM+EDX, clear EDX field error
                    if (this.value !== 'sem-and-edx') {
                        const edxEl = document.getElementById('edx-elements');
                        if (edxEl) clearInlineError(edxEl);
                    }
                });
            });
            document.querySelectorAll('input[name="conductive"]').forEach(r => {
                r.addEventListener('change', function(){
                    clearGroupErrorFor('input[name="conductive"]');
                });
            });

            // Expectations checkboxes
            document.querySelectorAll('input[name="expectations"]').forEach(cb => {
                cb.addEventListener('change', function(){
                    const chosen = document.querySelectorAll('input[name="expectations"]:checked');
                    if (chosen.length) clearGroupErrorFor('input[name="expectations"]');
                });
            });

            // File input
            const fileInput = document.getElementById('file-input');
            if (fileInput) fileInput.addEventListener('change', function(){ clearInlineError(this); });
        }

        window.addEventListener('load', initLiveValidation);

        // Phone input sanitizer: allow digits and + - ( ) space; keep first + only
        function sanitizePhoneValue(val) {
            if (!val) return '';
            let s = val.replace(/[^0-9+\-() ]+/g, '');
            const firstPlus = s.indexOf('+');
            if (firstPlus !== -1) {
                s = s.slice(0, firstPlus + 1) + s.slice(firstPlus + 1).replace(/\+/g, '');
            }
            return s;
        }

        function initPhoneSanitizer() {
            const el = document.getElementById('mobile-number');
            if (!el) return;
            el.setAttribute('inputmode','tel');
            el.addEventListener('input', function(){
                const cur = this.value;
                const sanitized = sanitizePhoneValue(cur);
                if (sanitized !== cur) this.value = sanitized;
            });
        }

        window.addEventListener('load', initPhoneSanitizer);

        // Set minimum date for delivery-date to today
        const deliveryDateInput = document.getElementById('delivery-date');
        if (deliveryDateInput) {
            deliveryDateInput.min = new Date().toISOString().split('T')[0];
        }

        // Initialize calculator and services total (load CSVs then compute)
        loadCostTables().then(() => {
            updateCost();
            updateServicesCost();
        });

        // Voucher UI setup and handlers
        function setVoucherStatus(msg, kind) {
            const s = document.getElementById('voucher-status');
            if (!s) return;
            s.textContent = msg || '';
            s.classList.remove('success', 'error');
            if (kind) s.classList.add(kind);
        }

        function initVoucherUI() {
            const totalEl = document.getElementById('services-total-cost');
            if (!totalEl) return; // Request form total not in DOM yet
            // Choose a host near the total (prefer the calc-result box)
            const host = totalEl.closest('.calc-result') || totalEl.parentElement;
            if (!host) return;

            // Avoid duplicate init
            if (document.getElementById('services-voucher')) return;

            // Voucher block
            const v = document.createElement('div');
            v.id = 'services-voucher';
            v.className = 'services-voucher';
            v.innerHTML = `
                <label for="voucher-input">Voucher Code</label>
                <div class="voucher-row">
                    <input id="voucher-input" type="text" placeholder="Enter code" autocomplete="off" inputmode="text" />
                </div>
                <div class="voucher-actions">
                    <button id="voucher-apply" type="button" class="btn-apply">Apply</button>
                    <button id="voucher-clear" type="button" class="btn-clear">Remove</button>
                </div>
                <div id="voucher-status" aria-live="polite"></div>
            `;
            host.appendChild(v);

            // Summary block (hidden by default)
            const sum = document.createElement('div');
            sum.id = 'services-summary';
            sum.className = 'services-summary';
            sum.hidden = true;
            sum.innerHTML = `
                <div class="summary-row">
                    <div class="summary-label">Sub total cost</div>
                    <div class="summary-value">₱ <span id="services-subtotal"></span></div>
                </div>
                <div class="summary-row">
                    <div class="summary-label">Discount</div>
                    <div class="summary-value">₱ <span id="services-discount"></span></div>
                </div>
                <div class="summary-row summary-total">
                    <div class="summary-label">Total Cost</div>
                    <div class="summary-value">₱ <span id="services-total-final"></span></div>
                </div>
            `;
            host.appendChild(sum);

            // Handlers
            const input = document.getElementById('voucher-input');
            const applyBtn = document.getElementById('voucher-apply');
            const clearBtn = document.getElementById('voucher-clear');

            // Initial button visibility: only Apply visible until a valid code is applied
            if (clearBtn) clearBtn.style.display = 'none';
            if (applyBtn) applyBtn.style.display = 'inline-block';

            applyBtn.addEventListener('click', function() {
                const code = (input.value || '').trim().toLowerCase();
                if (lastBaseServicesTotal === null) {
                    setVoucherStatus('Total not available yet. Select options first.', 'error');
                    return;
                }
                if (code === 'student') {
                    appliedVoucher = 'student';
                    setVoucherStatus('10% discount applied.', 'success');
                    updateServicesCost();
                    // Hide promo banner after successful apply
                    const pb = document.getElementById('promo-banner');
                    if (pb) {
                        pb.style.display = 'none';
                    }
                    // Toggle buttons: hide Apply, show Remove
                    if (applyBtn) applyBtn.style.display = 'none';
                    if (clearBtn) clearBtn.style.display = 'inline-block';
                    if (input) input.disabled = true;
                } else {
                    appliedVoucher = null;
                    setVoucherStatus('Invalid voucher code.', 'error');
                    updateServicesCost();
                    // Keep Apply visible, hide Remove on invalid code
                    if (applyBtn) applyBtn.style.display = 'inline-block';
                    if (clearBtn) clearBtn.style.display = 'none';
                    if (input) input.disabled = false;
                }
            });

            clearBtn.addEventListener('click', function() {
                appliedVoucher = null;
                if (input) input.value = '';
                setVoucherStatus('', null);
                updateServicesCost();
                // Restore buttons: show Apply, hide Remove
                if (applyBtn) applyBtn.style.display = 'inline-block';
                if (clearBtn) clearBtn.style.display = 'none';
                if (input) input.disabled = false;
                // Re-show promo banner when voucher is removed
                try {
                    if (typeof ensurePromoBannerVisibleIfEligible === 'function') {
                        ensurePromoBannerVisibleIfEligible();
                    } else {
                        const pb = document.getElementById('promo-banner');
                        if (pb) pb.style.display = '';
                    }
                } catch (_) {}
            });
        }

        // Initialize voucher UI after page load
        window.addEventListener('load', initVoucherUI);
        
        // Promo banner: lazy init on Request page only (dismiss without persistence)
        function initPromoBanner() {
            const banner = document.getElementById('promo-banner');
            if (!banner) return;
            if (banner.dataset.bound === '1') return; // already initialized
            const btn = banner.querySelector('.promo-dismiss');
            if (btn) {
                btn.addEventListener('click', function(){
                    banner.style.display = 'none';
                });
            }
            banner.dataset.bound = '1';
        }
        
        // Ensure banner visibility when navigating to Request page
        function ensurePromoBannerVisibleIfEligible() {
            const banner = document.getElementById('promo-banner');
            if (!banner) return;
            // ensure handlers are wired when we first land on Request page
            initPromoBanner();
            if (appliedVoucher === 'student') {
                banner.style.display = 'none';
            } else {
                banner.style.display = '';
            }
        }
        
        // Gallery & Lightbox
        let galleryThumbs = [];
        let currentLightboxIndex = -1;
        let lastFocusedElement = null;
        let lightboxHistoryActive = false;

        function setLightboxImage() {
            const imgEl = document.getElementById('lightbox-image');
            const thumb = galleryThumbs[currentLightboxIndex];
            if (thumb && imgEl) {
                imgEl.src = thumb.src;
                imgEl.alt = thumb.alt || '';
            }
        }

        function openLightbox(idx) {
            if (!galleryThumbs.length) return;
            currentLightboxIndex = idx;
            lastFocusedElement = document.activeElement;
            const overlay = document.getElementById('lightbox');
            overlay.style.display = 'flex';
            overlay.setAttribute('aria-hidden', 'false');
            setLightboxImage();
            document.body.style.overflow = 'hidden';
            document.addEventListener('keydown', onLightboxKeydown);
            const closeBtn = document.getElementById('lightbox-close');
            if (closeBtn) closeBtn.focus();

            // Push a history state so the Back button can close the lightbox
            if (!lightboxHistoryActive) {
                try {
                    history.pushState({ lightbox: true, index: currentLightboxIndex }, '');
                } catch (_) { /* no-op */ }
                window.addEventListener('popstate', onLightboxPopstate);
                lightboxHistoryActive = true;
            }
        }

        function closeLightbox(fromPopstate) {
            const overlay = document.getElementById('lightbox');
            overlay.style.display = 'none';
            overlay.setAttribute('aria-hidden', 'true');
            document.body.style.overflow = '';
            document.removeEventListener('keydown', onLightboxKeydown);
            if (lastFocusedElement && typeof lastFocusedElement.focus === 'function') {
                lastFocusedElement.focus();
            }

            // Clean up history handling; if user clicked close, pop our pushed state
            if (lightboxHistoryActive) {
                window.removeEventListener('popstate', onLightboxPopstate);
                lightboxHistoryActive = false;
                if (!fromPopstate) {
                    try { history.back(); } catch (_) { /* no-op */ }
                }
            }
        }

        function nextLightbox() {
            if (!galleryThumbs.length) return;
            currentLightboxIndex = (currentLightboxIndex + 1) % galleryThumbs.length;
            setLightboxImage();
        }

        function prevLightbox() {
            if (!galleryThumbs.length) return;
            currentLightboxIndex = (currentLightboxIndex - 1 + galleryThumbs.length) % galleryThumbs.length;
            setLightboxImage();
        }

        function onLightboxKeydown(e) {
            if (e.key === 'Escape') closeLightbox();
            if (e.key === 'ArrowRight') nextLightbox();
            if (e.key === 'ArrowLeft') prevLightbox();
        }

        function onLightboxPopstate(e) {
            if (lightboxHistoryActive) {
                closeLightbox(true);
            }
        }

        function initGallery() {
            // If thumbnails exist already, bind them (kept for safety; dynamic builder also binds individually)
            if (galleryThumbs.length === 0) {
                const existing = Array.from(document.querySelectorAll('.samples-grid img.sample-thumb'));
                existing.forEach((img, idx) => {
                    const index = galleryThumbs.length;
                    galleryThumbs.push(img);
                    img.setAttribute('data-index', String(index));
                    img.tabIndex = 0;
                    img.addEventListener('click', () => openLightbox(index));
                    img.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            openLightbox(index);
                        }
                    });
                });
            }
            const overlay = document.getElementById('lightbox');
            if (overlay) {
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) closeLightbox();
                });
            }
            const btnPrev = document.getElementById('lightbox-prev');
            const btnNext = document.getElementById('lightbox-next');
            const btnClose = document.getElementById('lightbox-close');
            if (btnPrev) btnPrev.addEventListener('click', prevLightbox);
            if (btnNext) btnNext.addEventListener('click', nextLightbox);
            if (btnClose) btnClose.addEventListener('click', closeLightbox);
        }

        window.addEventListener('load', initGallery);

        // Dynamically build the samples gallery by probing for files like "sample<n>.<ext>"
        // Option A: Preload off-DOM, then append only after successful load (no placeholders)
        function buildSamplesGallery(start = 1, max = 50) {
            const container = document.getElementById('samples-grid');
            if (!container) return;
            let loadedCount = 0;

            function registerThumb(img) {
                const index = galleryThumbs.length;
                galleryThumbs.push(img);
                img.setAttribute('data-index', String(index));
                img.tabIndex = 0;
                img.addEventListener('click', () => openLightbox(index));
                img.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        openLightbox(index);
                    }
                });
            }

            // Insert the loaded image in numeric order without creating visible placeholders
            function insertInOrder(imgEl, n) {
                imgEl.setAttribute('data-n', String(n));
                const children = Array.from(container.querySelectorAll('img.sample-thumb'));
                for (let i = 0; i < children.length; i++) {
                    const childN = parseInt(children[i].getAttribute('data-n') || '0', 10);
                    if (childN > n) {
                        container.insertBefore(imgEl, children[i]);
                        return;
                    }
                }
                container.appendChild(imgEl);
            }

            const exts = ['.png', '.PNG', '.jpg', '.JPG', '.jpeg', '.JPEG', '.webp'];
            for (let n = start; n <= max; n++) {
                // Build ordered candidates: prefer simple names, then legacy parentheses variant
                const candidates = [];
                for (const ext of exts) {
                    candidates.push(`Images/sample${n}${ext}`);
                    candidates.push(`Images/Sample${n}${ext}`);
                }
                for (const base of ['Samples', 'samples']) {
                    for (const ext of exts) {
                        const name = `${base} (${n})${ext}`;
                        candidates.push(`Images/${name}`);
                        candidates.push(`Images/${encodeURIComponent(name)}`);
                    }
                }

                // Preloader image (off-DOM)
                const pre = new Image();
                pre.decoding = 'async';
                const altText = `Sample micrograph ${n}`;
                let attempt = 0;

                const tryNext = () => {
                    if (attempt < candidates.length) {
                        pre.src = candidates[attempt++];
                    } else {
                        console.warn(`Gallery: no file found for index ${n}. Tried:`, candidates);
                        // Nothing appended for this index
                        pre.onload = pre.onerror = null;
                    }
                };

                pre.onload = () => {
                    // Reuse the preloader element as the final thumbnail
                    pre.className = 'sample-thumb';
                    pre.alt = altText;
                    // Do NOT set loading="lazy" here; preload already fetched the resource
                    insertInOrder(pre, n);
                    registerThumb(pre);
                    loadedCount++;
                    pre.onload = pre.onerror = null;
                };

                pre.onerror = () => {
                    tryNext();
                };

                tryNext();
            }

            // If nothing loaded, show a gentle message
            setTimeout(() => {
                if (loadedCount === 0) {
                    const note = document.createElement('div');
                    note.style.marginTop = '0.75rem';
                    note.style.color = '#6c757d';
                    note.style.fontSize = '0.95rem';
                    note.textContent = 'No sample images found. Expected files like "Images/sample1.png"';
                    container.appendChild(note);
                }
            }, 1600);
        }

        window.addEventListener('load', () => buildSamplesGallery(1, 50));

        // Lazy-load Facebook SDK only if feedback section exists (About page)
        window.addEventListener('load', function(){
            const feedback = document.getElementById('feedback-comments');
            if (feedback && !window.FB) {
                const sdk = document.createElement('script');
                sdk.async = true;
                sdk.defer = true;
                sdk.crossOrigin = 'anonymous';
                sdk.src = 'https://connect.facebook.net/en_US/sdk.js#xfbml=1&version=v22.0';
                document.body.appendChild(sdk);
            }
        });
        
        // Helper functions for form
        function toggleOtherPosition() {
            const position = document.getElementById('position').value;
            const otherGroup = document.getElementById('other-position-group');
            const otherInput = document.getElementById('other-position');
            
            if (position === 'other') {
                otherGroup.style.display = 'block';
                otherInput.required = true;
            } else {
                otherGroup.style.display = 'none';
                otherInput.required = false;
                otherInput.value = '';
            }
        }
        
        function toggleOtherExpectation() {
            const otherChecked = document.querySelector('input[name="expectations"][value="other"]:checked');
            const otherGroup = document.getElementById('other-expectation-group');
            const otherInput = document.getElementById('other-expectation');
            
            if (otherChecked) {
                otherGroup.style.display = 'block';
            } else {
                otherGroup.style.display = 'none';
                otherInput.value = '';
            }
        }

        // Prep Checklist: initialize and update logic
        function updatePrepChecklist(root) {
            if (!root) return;
            const yesCount = [
                'chk-solid', 'chk-small', 'chk-dried', 'chk-packed', 'chk-labeled'
            ].reduce((acc, name) => acc + (root.querySelector(`input[name="${name}"][value="yes"]:checked`) ? 1 : 0), 0);

            const status = root.querySelector('.checklist-status');
            if (status) status.textContent = `${yesCount}/5 Yes selected`;

            const ready = yesCount === 5;
            const msg = root.querySelector('.ready-message');
            if (msg) msg.hidden = !ready;
            root.classList.toggle('ready', !!ready);
        }

        function initPrepChecklist() {
            const card = document.getElementById('prep-checklist');
            if (!card) return;
            const inputs = card.querySelectorAll('input[type="radio"][name^="chk-"]');
            inputs.forEach(inp => inp.addEventListener('change', () => updatePrepChecklist(card)));
            updatePrepChecklist(card);
        }

        window.addEventListener('load', initPrepChecklist);

        // Extras: modal open/close (Learn more)
        (function initExtrasModals(){
            const openButtons = Array.from(document.querySelectorAll('[data-open-modal]'));
            if (!openButtons.length) return;

            let activeOverlay = null;
            let lastFocus = null;
            let prevBodyOverflow = '';

            function lockScroll(){
                prevBodyOverflow = document.body.style.overflow || '';
                document.body.style.overflow = 'hidden';
            }
            function unlockScroll(){
                document.body.style.overflow = prevBodyOverflow;
            }

            function pauseModalVideo(overlay){
                const v = overlay && overlay.querySelector('video');
                if (v && !v.paused) { try { v.pause(); } catch(_) {} }
            }

            function openModal(id){
                const overlay = document.getElementById('modal-' + id);
                if (!overlay) return;
                if (activeOverlay) closeModal(activeOverlay, true);

                lastFocus = document.activeElement;
                activeOverlay = overlay;
                overlay.classList.add('show');
                overlay.setAttribute('aria-hidden','false');
                lockScroll();

                // focus first actionable element
                const focusTarget = overlay.querySelector('.modal-close, [data-close-modal], a, button');
                if (focusTarget) focusTarget.focus();
            }

            function closeModal(overlay, internal){
                if (!overlay) return;
                overlay.classList.remove('show');
                overlay.setAttribute('aria-hidden','true');
                pauseModalVideo(overlay);
                unlockScroll();
                activeOverlay = null;
                if (!internal && lastFocus && typeof lastFocus.focus === 'function') {
                    lastFocus.focus();
                }
            }

            openButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const id = btn.getAttribute('data-open-modal');
                    openModal(id);
                });
            });

            document.addEventListener('click', (e) => {
                if (!activeOverlay) return;
                const target = e.target;
                if (target && target.matches && target.matches('[data-close-modal], .modal-close')) {
                    e.preventDefault();
                    closeModal(activeOverlay);
                    return;
                }
                // click outside modal closes
                if (target === activeOverlay) {
                    closeModal(activeOverlay);
                }
            });

            document.addEventListener('keydown', (e) => {
                if (!activeOverlay) return;
                if (e.key === 'Escape') {
                    e.preventDefault();
                    closeModal(activeOverlay);
                }
            });
        })();
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98ae0874705b04cf',t:'MTc1OTg0Njc2MS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
